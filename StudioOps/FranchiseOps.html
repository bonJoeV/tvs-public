<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studio Growth Command Center | The Vital Stretch</title>
    <link href="https://fonts.googleapis.com/css2?family=Yeseva+One&family=Questrial&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --blue: #013160;
            --cyan: #71BED2;
            --gold: #FBB514;
            --white: #fff;
            --gray: #F8F9FA;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
            --muted: #666;
            --border: #e0e0e0;
            --radius: 8px;
            --shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Questrial', sans-serif; background: var(--gray); color: #1a1a2e; min-height: 100vh; font-size: 14px; }

        /* Header - matching footer style */
        .header { background: var(--blue); padding: 1rem 2rem; }
        .header-content { max-width: 1600px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .logo-section { display: flex; align-items: center; gap: 0.75rem; }
        .logo-text { font-family: 'Yeseva One', serif; color: var(--white); font-size: 1.5rem; }
        .logo-text span { color: rgba(255,255,255,0.8); font-size: 0.75rem; letter-spacing: 2px; display: block; margin-top: -3px; }

        /* Layout */
        .main-container { max-width: 1600px; margin: 0 auto; padding: 1.5rem; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .page-title { font-weight: 600; color: var(--blue); font-size: 1.5rem; }
        .last-updated { font-size: 0.8rem; color: var(--muted); }

        /* Navigation */
        .nav-tabs { display: flex; gap: 0.25rem; margin-bottom: 1.5rem; background: var(--white); padding: 0.5rem; border-radius: 12px; box-shadow: var(--shadow); flex-wrap: wrap; }
        .nav-tab { padding: 0.6rem 1rem; background: none; border: none; font-family: inherit; font-size: 0.85rem; color: var(--muted); cursor: pointer; border-radius: var(--radius); transition: all 0.2s; white-space: nowrap; }
        .nav-tab:hover { background: var(--gray); color: var(--blue); }
        .nav-tab.active { background: var(--blue); color: var(--white); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Cards */
        .card { background: var(--white); border-radius: 12px; padding: 1.25rem; box-shadow: var(--shadow); margin-bottom: 1.25rem; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid #eee; }
        .card-title { font-family: 'Yeseva One', serif; color: var(--blue); font-size: 1.1rem; }
        .card-subtitle { font-size: 0.8rem; color: var(--muted); }

        /* Grids */
        .grid-2, .grid-3, .grid-4 { display: grid; gap: 1.25rem; }
        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-4 { grid-template-columns: repeat(4, 1fr); }

        /* Forms */
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; font-size: 0.8rem; color: var(--muted); margin-bottom: 0.3rem; font-weight: 500; }
        .form-group input, .form-group select { width: 100%; padding: 0.5rem 0.75rem; border: 2px solid var(--border); border-radius: 6px; font-size: 16px; font-family: inherit; transition: border-color 0.2s; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--cyan); }
        .form-group input.highlight { background: #FFFDE7; border-color: var(--gold); }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.75rem; }

        /* Stat & KPI boxes (shared styles) */
        .stat-box, .kpi-item { text-align: center; padding: 0.75rem 1rem; background: var(--gray); border-radius: var(--radius); }
        .stat-box .value, .kpi-item .value { font-family: 'Yeseva One', serif; color: var(--blue); }
        .stat-box .value { font-size: clamp(1.25rem, 4vw, 1.75rem); }
        .kpi-item .value { font-size: clamp(1.1rem, 3.5vw, 1.5rem); }
        .stat-box .label, .kpi-item .label { font-size: 0.7rem; color: var(--muted); margin-top: 0.25rem; }
        .kpi-item .label { text-transform: uppercase; letter-spacing: 0.5px; }
        .kpi-row { display: flex; gap: 0.75rem; margin-bottom: 1rem; flex-wrap: wrap; }
        .kpi-item { flex: 1 1 calc(20% - 0.75rem); min-width: 120px; }

        /* Status colors */
        .stat-box.success, .badge.success { background: #d4edda; }
        .stat-box.warning, .badge.warning { background: #fff3cd; }
        .stat-box.danger { background: #f8d7da; }
        .stat-box.info { background: #d1ecf1; }
        .stat-box.success .value { color: var(--success); }
        .stat-box.warning .value { color: #856404; }
        .stat-box.danger .value { color: var(--danger); }
        .stat-box.info .value { color: var(--info); }
        .badge { display: inline-block; padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.7rem; font-weight: 600; }
        .badge.success { color: #155724; }
        .badge.warning { color: #856404; }

        /* Legend box */
        .legend-box { font-size: 0.8rem; padding: 0.75rem; background: var(--gray); border-radius: 6px; display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: center; }
        .legend-item { white-space: nowrap; }

        /* Studio headers */
        .studio-header { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; border-radius: var(--radius); margin-bottom: 1rem; color: var(--white); }
        .studio-header.eden { background: var(--blue); }
        .studio-header.savage { background: var(--cyan); }
        .studio-header.slp { background: var(--gold); color: var(--blue); }
        .studio-header.minnetonka { background: linear-gradient(135deg, var(--blue), var(--cyan)); }
        .studio-header h3 { font-family: 'Yeseva One', serif; font-size: 1rem; flex: 1; }
        .studio-badge { font-size: 0.7rem; padding: 0.2rem 0.5rem; background: rgba(255,255,255,0.2); border-radius: 10px; }

        /* Tables */
        .data-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .data-table th { background: var(--blue); color: var(--white); padding: 0.6rem; text-align: center; font-weight: 500; white-space: nowrap; }
        .data-table th:first-child { text-align: left; border-radius: 6px 0 0 0; }
        .data-table th:last-child { border-radius: 0 6px 0 0; }
        .data-table td { padding: 0.5rem 0.6rem; border-bottom: 1px solid #eee; text-align: center; }
        .data-table td:first-child { text-align: left; font-weight: 500; }
        .data-table tr:hover td { background: rgba(113,190,210,0.1); }
        .data-table .total-row { background: var(--gray); font-weight: 600; }
        .table-scroll { overflow-x: auto; overflow-y: auto; max-height: 400px; -webkit-overflow-scrolling: touch; }
        .table-scroll table { min-width: max-content; }

        /* Charts & Progress */
        .chart-container { position: relative; height: 280px; }
        .progress-bar { height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; margin: 0.5rem 0; }
        .progress-bar .fill { height: 100%; border-radius: 4px; transition: width 0.5s; }
        .progress-bar .fill.success { background: var(--success); }
        .progress-bar .fill.warning { background: var(--warning); }
        .progress-bar .fill.danger { background: var(--danger); }

        /* Scenarios */
        .scenario-card { border: 2px solid var(--border); border-radius: 10px; overflow: hidden; transition: all 0.3s; opacity: 0.7; }
        .scenario-card.active { border-color: var(--blue); opacity: 1; box-shadow: 0 4px 15px rgba(1,49,96,0.2); transform: scale(1.02); }
        .scenario-card.active .scenario-header { position: relative; }
        .scenario-card.active .scenario-header::after { content: '‚úì SELECTED'; position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); font-size: 0.7rem; background: white; padding: 0.15rem 0.5rem; border-radius: 10px; }
        .scenario-header { padding: 0.75rem; background: var(--gray); font-weight: 600; text-align: center; }
        .scenario-card.conservative .scenario-header { background: #d1ecf1; color: var(--info); }
        .scenario-card.moderate .scenario-header { background: #d4edda; color: var(--success); }
        .scenario-card.aggressive .scenario-header { background: #fff3cd; color: #856404; }
        .scenario-card.custom .scenario-header { background: #e2d5f1; color: #6f42c1; }
        .scenario-body { padding: 1rem; }
        .scenario-stat { display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #eee; font-size: 0.85rem; }
        .scenario-stat:last-child { border-bottom: none; }

        /* Sliders */
        .slider-group { margin-bottom: 1rem; }
        .slider-group label { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--muted); margin-bottom: 0.3rem; }
        .slider-group input[type="range"] { width: 100%; height: 6px; appearance: none; -webkit-appearance: none; background: var(--border); border-radius: 3px; }
        .slider-group input[type="range"]::-webkit-slider-thumb { appearance: none; -webkit-appearance: none; width: 16px; height: 16px; background: var(--blue); border-radius: 50%; cursor: pointer; }

        /* Footer & Utilities */
        .footer { background: var(--blue); padding: 1.5rem; margin-top: 2rem; text-align: center; color: var(--white); }
        .footer-tagline { font-family: 'Yeseva One', serif; font-size: 0.75rem; font-style: italic; }
        .text-muted { color: var(--muted); }
        .mb-1 { margin-bottom: 0.5rem; }
        .mt-1 { margin-top: 0.5rem; }
        .mt-2 { margin-top: 1rem; }

        /* Preset Buttons */
        .preset-btn { padding: 0.5rem 1rem; border: 2px solid var(--border); border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 600; transition: all 0.2s; background: var(--white); }
        .preset-btn:hover { transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .preset-btn.conservative { border-color: var(--info); color: var(--info); }
        .preset-btn.conservative:hover, .preset-btn.conservative.active { background: var(--info); color: white; }
        .preset-btn.moderate { border-color: var(--success); color: var(--success); }
        .preset-btn.moderate:hover, .preset-btn.moderate.active { background: var(--success); color: white; }
        .preset-btn.aggressive { border-color: var(--warning); color: #856404; }
        .preset-btn.aggressive:hover, .preset-btn.aggressive.active { background: var(--warning); color: #856404; }

        /* Print Mode Toggle */
        .print-mode .form-group, .print-mode .slider-group, .print-mode .whatif-btn, .print-mode #whatIfButtonsContainer,
        .print-mode .preset-btn, .print-mode #presetContainer, .print-mode .page-header button { display: none !important; }
        .print-mode .card { box-shadow: none; border: 1px solid #ddd; }
        .print-mode .nav-tabs { display: none; }
        .print-mode #globalSettingsBanner { padding: 0.4rem 1rem; font-size: 0.8rem; }
        .print-mode .tab-content { display: block !important; margin-bottom: 1.5rem; }
        .print-mode .tab-content::before { content: attr(data-tab-title); display: block; font-family: 'Yeseva One', serif; font-size: 1.25rem; color: var(--blue); margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--blue); }

        /* Print Styles */
        @media print {
            body { background: white; font-size: 11pt; }
            .header, .nav-tabs, .slider-group input[type="range"], button, .preset-btn, #presetContainer, .whatif-btn, #whatIfButtonsContainer { display: none !important; }
            .main-container { padding: 0; max-width: 100%; }
            .page-header { margin-bottom: 0.5rem; }
            .page-header > div { display: none !important; } /* Hide action buttons */
            .card { break-inside: avoid; box-shadow: none; border: 1px solid #ddd; margin-bottom: 0.75rem; padding: 0.75rem; }
            .chart-container { height: 200px !important; }
            .grid-2, .grid-3, .grid-4 { gap: 0.5rem; }
            .kpi-row { gap: 0.5rem; }
            .kpi-item, .stat-box { padding: 0.5rem; }
            .tab-content { display: block !important; page-break-before: always; }
            .tab-content:first-of-type { page-break-before: auto; }
            #tab-dashboard { display: block !important; }
            .form-group { display: none !important; } /* Hide all form inputs */
            .form-row { display: none !important; }
            /* Show values only */
            .stat-box, .kpi-item { display: block !important; }
            @page { margin: 0.5in; }
        }

        /* Confidence bands */
        .confidence-band { fill-opacity: 0.15; }
        
        /* What-if buttons */
        .whatif-btn { padding: 0.4rem 0.75rem; background: var(--gray); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-size: 0.75rem; transition: all 0.2s; }
        .whatif-btn:hover { background: var(--cyan); color: white; border-color: var(--cyan); }
        .whatif-btn.active { background: var(--blue); color: white; border-color: var(--blue); }
        
        /* Seasonality visual */
        .season-bar { height: 24px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: 600; transition: all 0.3s; }
        .season-high { background: linear-gradient(90deg, #d4edda, #28a745); color: #155724; }
        .season-low { background: linear-gradient(90deg, #f8d7da, #dc3545); color: #721c24; }
        .season-normal { background: var(--gray); color: var(--muted); }
        
        /* Validation styles */
        .form-group input.invalid { border-color: var(--danger); background: #fff5f5; }
        .validation-msg { font-size: 0.7rem; color: var(--danger); margin-top: 0.2rem; display: none; }
        .form-group input.invalid + .validation-msg { display: block; }

        /* ==========================================
           RESPONSIVE BREAKPOINTS
           ========================================== */
        
        /* Large screens (1200px and up) - default styles above */
        
        /* Medium screens (992px - 1199px) */
        @media (max-width: 1199px) {
            .grid-4 { grid-template-columns: repeat(2, 1fr); }
            .main-container { padding: 1rem; }
            .chart-container { height: 250px; }
        }
        
        /* Tablets (768px - 991px) */
        @media (max-width: 991px) {
            .grid-3 { grid-template-columns: repeat(2, 1fr); }
            .page-header { flex-direction: column; gap: 1rem; align-items: flex-start; }
            .page-title { font-size: 1.25rem; }
            .nav-tabs { justify-content: flex-start; overflow-x: auto; -webkit-overflow-scrolling: touch; }
            .nav-tab { flex-shrink: 0; }
            .kpi-item { flex: 1 1 calc(33.333% - 0.75rem); }
            .scenario-body { padding: 0.75rem; }
            .scenario-stat { font-size: 0.8rem; }
        }
        
        /* Small tablets / Large phones (576px - 767px) */
        @media (max-width: 767px) {
            body { font-size: 13px; }
            .header { padding: 0.75rem 1rem; }
            .logo-text { font-size: 1.25rem; }
            .logo-text span { font-size: 0.65rem; }
            .main-container { padding: 0.75rem; }
            .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; gap: 1rem; }
            .card { padding: 1rem; margin-bottom: 1rem; }
            .card-header { flex-direction: column; align-items: flex-start; gap: 0.25rem; }
            .card-title { font-size: 1rem; }
            .kpi-row { gap: 0.5rem; }
            .kpi-item { flex: 1 1 calc(50% - 0.5rem); min-width: 0; padding: 0.5rem; }
            .kpi-item .value { font-size: 1.1rem; }
            .kpi-item .label { font-size: 0.6rem; }
            .stat-box { padding: 0.5rem; }
            .stat-box .value { font-size: 1.25rem; }
            .chart-container { height: 220px; }
            .form-row { grid-template-columns: repeat(2, 1fr); gap: 0.5rem; }
            .data-table { font-size: 0.75rem; }
            .data-table th, .data-table td { padding: 0.4rem; }
            .table-scroll { max-height: 300px; }
            .whatif-btn { padding: 0.35rem 0.5rem; font-size: 0.7rem; }
            .nav-tabs { padding: 0.35rem; gap: 0.15rem; }
            .nav-tab { padding: 0.5rem 0.75rem; font-size: 0.75rem; }
            #seasonalityInputs { grid-template-columns: repeat(3, 1fr) !important; }
            #seasonalityVisual { grid-template-columns: repeat(6, 1fr) !important; }
            .footer { padding: 1rem; margin-top: 1rem; }
        }
        
        /* Mobile phones (under 576px) */
        @media (max-width: 575px) {
            body { font-size: 12px; }
            .header { padding: 0.5rem 0.75rem; }
            .logo-text { font-size: 1.1rem; }
            .main-container { padding: 0.5rem; }
            .page-header { margin-bottom: 1rem; }
            .page-title { font-size: 1.1rem; }
            .page-header button { padding: 0.3rem 0.5rem; font-size: 0.7rem; }
            .card { padding: 0.75rem; border-radius: 8px; }
            .card-title { font-size: 0.9rem; }
            .kpi-item { flex: 1 1 100%; }
            .kpi-item .value { font-size: 1.3rem; }
            .stat-box .value { font-size: 1.1rem; }
            .stat-box .label { font-size: 0.65rem; }
            .form-row { grid-template-columns: 1fr; }
            .form-group { margin-bottom: 0.75rem; }
            .form-group label { font-size: 0.75rem; }
            .form-group input, .form-group select { padding: 0.6rem; font-size: 16px; } /* 16px prevents iOS zoom */
            .chart-container { height: 200px; }
            .nav-tabs { margin-bottom: 1rem; }
            .nav-tab { padding: 0.4rem 0.6rem; font-size: 0.7rem; }
            .studio-header { padding: 0.5rem; }
            .studio-header h3 { font-size: 0.9rem; }
            .studio-badge { font-size: 0.6rem; padding: 0.15rem 0.4rem; }
            .data-table { font-size: 0.7rem; }
            .data-table th, .data-table td { padding: 0.3rem 0.25rem; }
            .data-table td:first-child { max-width: 80px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
            #seasonalityInputs { grid-template-columns: repeat(2, 1fr) !important; }
            #seasonalityVisual { grid-template-columns: repeat(4, 1fr) !important; }
            .slider-group label { font-size: 0.7rem; }
            .scenario-card { margin-bottom: 0.75rem; }
            .scenario-header { padding: 0.5rem; font-size: 0.85rem; }
            .scenario-body { padding: 0.5rem; }
            .scenario-stat { padding: 0.35rem 0; font-size: 0.75rem; }
            .badge { font-size: 0.6rem; padding: 0.15rem 0.4rem; }
            .whatif-btn { padding: 0.3rem 0.4rem; font-size: 0.65rem; }
            .progress-bar { height: 6px; }
            .footer { padding: 0.75rem; }
            .footer-tagline { font-size: 0.65rem; }
            .legend-box { font-size: 0.7rem; padding: 0.5rem; gap: 0.5rem; flex-direction: column; align-items: flex-start; }
            .legend-item { font-size: 0.65rem; }
            /* Presets and controls on mobile */
            #presetContainer { flex-wrap: wrap; justify-content: center; }
            .preset-btn { padding: 0.35rem 0.6rem; font-size: 0.7rem; flex: 1 1 auto; min-width: 80px; text-align: center; }
            .page-header { flex-direction: column; gap: 0.75rem; align-items: stretch !important; }
            .page-header > div { justify-content: center; flex-wrap: wrap; }
            #timeHorizon { font-size: 0.75rem; padding: 0.35rem 0.4rem; }
            /* Global settings banner mobile - stack below tabs */
            #globalSettingsBanner { width: 100%; justify-content: center; margin-top: 0.5rem; }
        }
        
        /* Extra small phones (under 400px) */
        @media (max-width: 399px) {
            .logo-text { font-size: 1rem; }
            .logo-text span { font-size: 0.6rem; letter-spacing: 1px; }
            .page-title { font-size: 1rem; }
            .nav-tab { padding: 0.35rem 0.5rem; font-size: 0.65rem; }
            .kpi-item .value { font-size: 1.1rem; }
            .chart-container { height: 180px; }
            #seasonalityInputs { grid-template-columns: repeat(2, 1fr) !important; }
            #seasonalityVisual { display: none; } /* Hide visual on very small screens */
        }
        
        /* Touch-friendly improvements */
        @media (hover: none) and (pointer: coarse) {
            .nav-tab, .whatif-btn, button { min-height: 44px; min-width: 44px; }
            .form-group input, .form-group select { min-height: 44px; }
            .slider-group input[type="range"] { height: 8px; }
            .slider-group input[type="range"]::-webkit-slider-thumb { width: 24px; height: 24px; }
            .data-table td, .data-table th { padding: 0.5rem; }
        }
        
        /* Landscape orientation on mobile */
        @media (max-height: 500px) and (orientation: landscape) {
            .header { padding: 0.4rem 1rem; }
            .main-container { padding: 0.5rem; }
            .kpi-row { margin-bottom: 0.5rem; }
            .kpi-item { padding: 0.4rem; }
            .card { padding: 0.75rem; margin-bottom: 0.75rem; }
            .chart-container { height: 150px; }
        }
        
        /* Mobile table scroll hint */
        @media (max-width: 767px) {
            .table-scroll { position: relative; }
            .table-scroll::after {
                content: '‚Üí Scroll for more';
                position: absolute;
                top: 0.5rem;
                right: 0.5rem;
                font-size: 0.65rem;
                color: var(--muted);
                background: rgba(255,255,255,0.9);
                padding: 0.2rem 0.5rem;
                border-radius: 4px;
                opacity: 1;
                pointer-events: none;
                animation: fadeHint 3s forwards;
            }
            @keyframes fadeHint {
                0%, 70% { opacity: 1; }
                100% { opacity: 0; }
            }
            /* Stack legend items on mobile */
            .card > div[style*="Legend"] {
                line-height: 1.8;
            }
        }
        
        /* Dark mode support (optional - follows system preference) */
        @media (prefers-color-scheme: dark) {
            /* Uncomment to enable dark mode
            :root {
                --gray: #1a1a2e;
                --white: #2d2d44;
                --border: #3d3d5c;
                --muted: #a0a0b0;
            }
            body { background: #0f0f1a; color: #e0e0e0; }
            .card { background: var(--white); }
            .data-table th { background: var(--blue); }
            .form-group input, .form-group select { background: var(--gray); color: #e0e0e0; }
            */
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo-text">
                    Vital
                    <span>S T R E T C H</span>
                </div>
            </div>
        </div>
    </header>

    <main class="main-container">
        <div class="page-header">
            <h1 class="page-title">Twin Cities Command Center</h1>
            <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                <!-- Time Horizon -->
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <label style="font-size: 0.8rem; color: var(--muted);">Horizon:</label>
                    <select id="timeHorizon" onchange="changeTimeHorizon(this.value)" style="padding: 0.4rem 0.5rem; border: 2px solid var(--border); border-radius: 6px; font-size: 0.8rem; font-weight: 600; cursor: pointer;">
                        <option value="13">13 Mo (Dec '26)</option>
                        <option value="25">25 Mo (Dec '27)</option>
                        <option value="37">37 Mo (Dec '28)</option>
                    </select>
                </div>
                <span class="last-updated">|</span>
                <!-- Quick Presets -->
                <div id="presetContainer" style="display: flex; gap: 0.5rem;">
                    <button class="preset-btn conservative" onclick="applyPreset('conservative')" title="8% ramp, 5% churn, 18% conv">üê¢ Conservative</button>
                    <button class="preset-btn moderate active" onclick="applyPreset('moderate')" title="12% ramp, 4.5% churn, 21% conv">‚öñÔ∏è Moderate</button>
                    <button class="preset-btn aggressive" onclick="applyPreset('aggressive')" title="15% ramp, 4% churn, 25% conv">üöÄ Aggressive</button>
                </div>
                <span class="last-updated">|</span>
                <button onclick="togglePrintMode()" style="padding: 0.4rem 0.75rem; background: var(--cyan); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">üñ®Ô∏è Print View</button>
                <button onclick="saveSettings()" style="padding: 0.4rem 0.75rem; background: var(--blue); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">üíæ Save</button>
                <button onclick="resetSettings()" style="padding: 0.4rem 0.75rem; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">üîÑ Reset</button>
            </div>
        </div>

        <!-- Navigation with Settings Banner -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; gap: 1rem; flex-wrap: wrap;">
            <nav class="nav-tabs" style="margin-bottom: 0;">
                <button class="nav-tab active" data-tab="dashboard">üìä Dashboard</button>
                <button class="nav-tab" data-tab="leads">üéØ Lead Funnel</button>
                <button class="nav-tab" data-tab="financials">üí∞ Financials</button>
                <button class="nav-tab" data-tab="operations">üë• Operations</button>
                <button class="nav-tab" data-tab="scenarios">üìà Scenarios</button>
                <button class="nav-tab" data-tab="franchise">‚öôÔ∏è Franchise Setup</button>
            </nav>
            
            <!-- Global Settings Banner -->
            <div id="globalSettingsBanner" style="display: flex; align-items: center; gap: 1rem; padding: 0.4rem 0.75rem; background: var(--gray); border-radius: 6px; flex-wrap: wrap;">
                <div style="display: flex; align-items: center; gap: 0.4rem;">
                    <span style="font-size: 0.7rem; color: var(--muted);">Scenario:</span>
                    <span id="globalPresetName" style="font-weight: 700; color: var(--blue); font-size: 0.8rem;">Moderate</span>
                </div>
                <div style="height: 16px; width: 1px; background: var(--border);"></div>
                <div style="display: flex; gap: 0.75rem; align-items: center;">
                    <div style="text-align: center;">
                        <div style="font-size: 0.6rem; color: var(--muted);">Ramp</div>
                        <div id="globalRamp" style="font-weight: 600; color: var(--success); font-size: 0.8rem;">12%</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 0.6rem; color: var(--muted);">Maint</div>
                        <div id="globalMaint" style="font-weight: 600; color: var(--info); font-size: 0.8rem;">5%</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 0.6rem; color: var(--muted);">Churn</div>
                        <div id="globalChurn" style="font-weight: 600; color: var(--danger); font-size: 0.8rem;">4.5%</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 0.6rem; color: var(--muted);">Conv</div>
                        <div id="globalConv" style="font-weight: 600; color: var(--blue); font-size: 0.8rem;">21%</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 0.6rem; color: var(--muted);">Net</div>
                        <div id="globalNetGrowth" style="font-weight: 600; color: var(--cyan); font-size: 0.8rem;">7.5%</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: Dashboard -->
        <div class="tab-content active" id="tab-dashboard">
            <!-- KPI Summary -->
            <div class="kpi-row">
                <div class="kpi-item">
                    <div class="value" id="kpi-total-dec">415</div>
                    <div class="label">Total Members Dec '26</div>
                </div>
                <div class="kpi-item">
                    <div class="value" id="kpi-revenue">$62K</div>
                    <div class="label">Monthly Revenue Dec '26</div>
                </div>
                <div class="kpi-item">
                    <div class="value" id="kpi-studios-target">2/4</div>
                    <div class="label">Studios Hitting M9 Target</div>
                </div>
                <div class="kpi-item">
                    <div class="value" id="kpi-leads-needed">312</div>
                    <div class="label">Leads Needed This Month</div>
                </div>
                <div class="kpi-item">
                    <div class="value" id="kpi-vsp-needed">17</div>
                    <div class="label">Staff (FTE+PT) Dec '26</div>
                </div>
            </div>

            <div class="grid-2">
                <!-- Growth Chart -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Portfolio Growth Trajectory</span>
                    </div>
                    <div class="chart-container">
                        <canvas id="dashGrowthChart"></canvas>
                    </div>
                </div>

                <!-- Studio Summary -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Studio Status Overview</span>
                    </div>
                    <div id="studioStatusCards"></div>
                </div>
            </div>

            <div class="grid-2">
                <!-- Revenue Projection - Stacked by Studio -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Revenue by Studio</span>
                        <span class="card-subtitle">Monthly revenue stacked by location</span>
                    </div>
                    <div class="chart-container">
                        <canvas id="dashRevenueChart"></canvas>
                    </div>
                </div>

                <!-- Cash Runway -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">üí∞ Cash Runway</span>
                        <span class="card-subtitle">Cash needed to reach profitability</span>
                    </div>
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label>Starting Cash on Hand</label>
                        <input type="number" id="starting-cash" value="100000" step="5000">
                    </div>
                    <div class="grid-3" style="gap: 0.75rem; margin-bottom: 1rem;">
                        <div class="stat-box" style="text-align: center;">
                            <div id="cash-lowest" style="font-size: 1.5rem; font-weight: 700; color: var(--danger);">-$50K</div>
                            <div style="font-size: 0.75rem; color: var(--muted);">Lowest Point</div>
                        </div>
                        <div class="stat-box" style="text-align: center;">
                            <div id="cash-needed" style="font-size: 1.5rem; font-weight: 700; color: var(--blue);">$150K</div>
                            <div style="font-size: 0.75rem; color: var(--muted);">Total Cash Needed</div>
                        </div>
                        <div class="stat-box" style="text-align: center;">
                            <div id="cash-break-even-month" style="font-size: 1.5rem; font-weight: 700; color: var(--success);">Aug '26</div>
                            <div style="font-size: 0.75rem; color: var(--muted);">Break-Even Month</div>
                        </div>
                    </div>
                    <div class="chart-container" style="height: 180px;">
                        <canvas id="cashRunwayChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Break-even Timeline - Full Width -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Break-Even Progress</span>
                </div>
                <div id="breakEvenBars"></div>
            </div>

            <!-- Performance vs Benchmarks -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Performance vs Benchmarks</span>
                    <span class="text-muted" style="font-size: 0.7rem;">Sources: IHRSA, Association of Fitness Studios (AFS), Wellness Creative Co</span>
                </div>
                <div class="grid-4">
                    <div>
                        <div class="text-muted mb-1" style="font-size: 0.8rem;">Avg Ramp to 100 Members</div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.9rem;">
                            <span>Your Target:</span><strong id="bench-ramp">9 months</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.9rem;">
                            <span>Industry Avg:</span><strong>12-24 months</strong>
                        </div>
                        <div class="text-muted" style="font-size: 0.7rem; font-style: italic;">Boutique studio typical range</div>
                        <span class="badge mt-1" id="bench-ramp-badge">Ambitious</span>
                    </div>
                    <div>
                        <div class="text-muted mb-1" style="font-size: 0.8rem;">Monthly Churn Rate</div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.9rem;">
                            <span>Your Rate:</span><strong id="bench-churn">4%</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.9rem;">
                            <span>Industry Avg:</span><strong>4-7%</strong>
                        </div>
                        <div class="text-muted" style="font-size: 0.7rem; font-style: italic;">IHRSA: 27.6% annual dropout; 50% quit within 6 months</div>
                        <span class="badge mt-1" id="bench-churn-badge">Good</span>
                    </div>
                    <div>
                        <div class="text-muted mb-1" style="font-size: 0.8rem;">Lead ‚Üí Member Conversion</div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.9rem;">
                            <span>Your Rate:</span><strong id="bench-conv">19.3%</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.9rem;">
                            <span>Industry Avg:</span><strong>10-20%</strong>
                        </div>
                        <div class="text-muted" style="font-size: 0.7rem; font-style: italic;">Boutique studios with high-touch sales: 15-25%</div>
                        <span class="badge mt-1" id="bench-conv-badge">On Track</span>
                    </div>
                    <div>
                        <div class="text-muted mb-1" style="font-size: 0.8rem;">Avg Revenue Per Member/Mo</div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.9rem;">
                            <span>Your Rate:</span><strong id="bench-arpm">$158</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.9rem;">
                            <span>Industry Avg:</span><strong>$130-260</strong>
                        </div>
                        <div class="text-muted" style="font-size: 0.7rem; font-style: italic;">AFS: Boutique avg $65/mo; specialty services 2-4x higher</div>
                        <span class="badge mt-1" id="bench-arpm-badge">Good</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: Lead Funnel -->
        <div class="tab-content" id="tab-leads">
            <div class="grid-2">
                <!-- Conversion Summary -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Conversion Rates & Ad Spend by Studio</span>
                        <span class="card-subtitle">CPL & labor rates set per-studio in Franchise Setup tab</span>
                    </div>
                    <div id="conversionDisplaysContainer" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem;">
                        <!-- Generated dynamically -->
                    </div>
                    <div class="form-row mt-2">
                        <div class="form-group">
                            <label>Avg Cost Per Lead</label>
                            <div class="stat-box mt-1">
                                <div class="value" id="avg-cpl">$28</div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Total Ad Budget (Active)</label>
                            <div class="stat-box info mt-1">
                                <div class="value" id="total-ad-budget">$5,500</div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Customer Acquisition Cost</label>
                            <div class="stat-box warning mt-1">
                                <div class="value" id="cac">$234</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Monthly Funnel -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Monthly Funnel Requirements</span>
                        <span class="card-subtitle">Based on growth targets</span>
                    </div>
                    <div class="chart-container" style="height: 200px;">
                        <canvas id="funnelChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Lead Requirements Table -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Monthly Lead & Intro Requirements + Budget Analysis</span>
                    <span class="card-subtitle">Green = budget covers need, Red = budget shortfall</span>
                </div>
                <div class="table-scroll">
                    <table class="data-table" id="leadTable">
                        <thead id="leadTableHead">
                            <!-- Generated dynamically -->
                        </thead>
                        <tbody id="leadTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Weekly Targets -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Weekly Targets (Current Month)</span>
                </div>
                <div class="grid-4" id="weeklyTargets">
                    <!-- Generated -->
                </div>
            </div>

            <!-- Ad Spend -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Ad Budget vs Cost for Leads Needed</span>
                    <span class="card-subtitle">Blue = your budget, Red = what you'd need to spend</span>
                </div>
                <div class="chart-container">
                    <canvas id="marketingChart"></canvas>
                </div>
            </div>

            <!-- ROI Calculator -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">üìä Marketing ROI by Studio</span>
                    <span class="card-subtitle">Return on Ad Spend (ROAS) & LTV:CAC Analysis</span>
                </div>
                <div class="grid-4" id="roiCards">
                    <!-- Generated dynamically -->
                </div>
                <div class="mt-1" style="font-size: 0.8rem; padding: 0.75rem; background: var(--gray); border-radius: 6px;">
                    <strong>Key Metrics:</strong> 
                    <span style="color: var(--success);">ROAS > 3x = Excellent</span> | 
                    <span style="color: #856404;">2-3x = Good</span> | 
                    <span style="color: var(--danger);">< 2x = Review spend</span>.
                    LTV assumes avg 18-month membership lifespan.
                </div>
            </div>

            <!-- Ad Spend Recommendations -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">üí° Recommended Monthly Ad Spend by Studio</span>
                    <span class="card-subtitle">Month-by-month recommendations based on leads needed to hit growth targets</span>
                </div>
                <div class="table-scroll">
                    <table class="data-table" id="adSpendRecommendationTable">
                        <thead id="adSpendTableHead">
                            <!-- Generated dynamically -->
                        </thead>
                        <tbody id="adSpendRecommendationBody"></tbody>
                    </table>
                </div>
                <div class="legend-box mt-1">
                    <strong>Legend:</strong>
                    <span class="legend-item" style="color: var(--success);">üü¢ Current budget covers need</span>
                    <span class="legend-item" style="color: var(--danger);">üî¥ Increase recommended</span>
                    <span class="legend-item" style="color: var(--info);">üîµ Consider reducing (surplus > 5 leads)</span>
                    <span class="legend-item" style="background: #fff3cd; padding: 0.15rem 0.4rem; border-radius: 3px;">üü° Launch period (accelerated spend)</span>
                </div>
            </div>
        </div>
        <div class="tab-content" id="tab-financials">
            <div class="grid-3">
                <!-- Break-even -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Break-Even Analysis</span>
                        <span class="card-subtitle">Incl. mgmt allocation</span>
                    </div>
                    <div class="stat-box info mb-1">
                        <div class="value" id="break-even-members">80</div>
                        <div class="label">Avg Members to Break Even</div>
                    </div>
                    <div class="stat-box warning mb-1">
                        <div class="value" id="break-even-revenue">$12,000</div>
                        <div class="label">Break-Even Revenue/Studio</div>
                    </div>
                    <div class="stat-box success mb-1">
                        <div class="value" id="contribution-margin">$92</div>
                        <div class="label">Contribution / Member</div>
                    </div>
                    <div class="stat-box mb-1" id="safety-margin-box">
                        <div class="value" id="safety-margin">120%</div>
                        <div class="label">Safety Margin (Dec)</div>
                    </div>
                    <div class="stat-box" style="background: var(--gray);">
                        <div class="value" id="avg-fixed-cost">$8,500</div>
                        <div class="label">Avg Fixed Cost/Studio</div>
                    </div>
                </div>

                <!-- Cost Summary -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Cost Summary</span>
                        <span class="card-subtitle">Configure in Franchise Setup tab</span>
                    </div>
                    <div class="stat-box mb-1">
                        <div class="value" id="calc-arpm">$158</div>
                        <div class="label">ARPM (Avg Rev/Member/Mo)</div>
                    </div>
                    <div class="stat-box warning mb-1">
                        <div class="value" id="total-fee-pct">12%</div>
                        <div class="label">Total Fees</div>
                    </div>
                    <div class="stat-box mb-1">
                        <div class="value" id="total-mgmt-cost">$7,500</div>
                        <div class="label">Mgmt+Owner/Mo</div>
                    </div>
                    <div class="stat-box info mb-1">
                        <div class="value" id="total-rent-display">$12,721</div>
                        <div class="label">Total Rent</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="total-fixed-display">$22,721</div>
                        <div class="label">Total Fixed</div>
                    </div>
                </div>

                <!-- Break-Even Bars -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Break-Even Progress by Studio</span>
                    </div>
                    <div id="breakEvenBarsFinancials"></div>
                </div>
            </div>

            <!-- Revenue Table -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Monthly Revenue & Contribution Margin</span>
                </div>
                <div class="table-scroll">
                    <table class="data-table" id="financeTable">
                        <thead id="financeTableHead">
                            <!-- Generated dynamically -->
                        </thead>
                        <tbody id="financeTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- P&L Chart -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Profit & Loss Trajectory</span>
                </div>
                <div class="chart-container">
                    <canvas id="plChart"></canvas>
                </div>
            </div>

            <!-- Break-Even Timeline by Studio -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">üìà Studio Break-Even Timeline</span>
                    <span class="card-subtitle">When each studio reaches monthly profitability</span>
                </div>
                <div class="grid-4" id="studioBreakEvenCards">
                    <!-- Generated dynamically -->
                </div>
                <div class="chart-container" style="height: 250px;">
                    <canvas id="breakEvenTimelineChart"></canvas>
                </div>
            </div>
        </div>

        <!-- TAB: Operations -->
        <div class="tab-content" id="tab-operations">
            <!-- What-If Quick Toggles -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">‚ö° What-If Scenarios</span>
                    <span class="card-subtitle">Toggle to see instant impact</span>
                </div>
                <div id="whatIfButtonsContainer" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                    <!-- Studio delay buttons will be generated dynamically -->
                    <button class="whatif-btn" data-whatif="high-churn" title="Churn increases to 6%">üìâ High Churn (+2%)</button>
                    <button class="whatif-btn" data-whatif="low-conv" title="Conversion drops 25%">üéØ Low Conversion (-25%)</button>
                    <button class="whatif-btn" data-whatif="slow-ramp" title="Ramp growth drops to 10%">üê¢ Slow Ramp (10%)</button>
                    <button class="whatif-btn" data-whatif="no-seasonality" title="Remove seasonality effects">üìÖ No Seasonality</button>
                </div>
                <div id="whatif-impact" style="margin-top: 1rem; padding: 0.75rem; background: var(--gray); border-radius: 6px; display: none;">
                    <strong style="color: var(--blue);">Impact:</strong> <span id="whatif-impact-text"></span>
                </div>
            </div>
            
            <!-- Capacity Summary -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Capacity & Labor Summary</span>
                    <span class="card-subtitle">All settings configured in Franchise Setup tab</span>
                </div>
                <div class="grid-4" id="opsUtilContainer" style="margin-bottom: 0.75rem;">
                    <!-- Generated dynamically -->
                </div>
                <div class="grid-4">
                        <div class="stat-box">
                            <div class="value" id="avg-blended-rate">$18.50</div>
                            <div class="label">Avg Blended VSP Rate</div>
                        </div>
                        <div class="stat-box info">
                            <div class="value" id="total-capacity">692</div>
                            <div class="label">Total Portfolio Capacity</div>
                        </div>
                        <div class="stat-box success">
                            <div class="value" id="headroom">+277</div>
                            <div class="label">Headroom Dec '26</div>
                        </div>
                        <div class="stat-box" id="staff-cost-box">
                            <div class="value" id="staff-cost-per-member">$42</div>
                            <div class="label">Labor Cost/Member/Mo</div>
                        </div>
                    </div>
                    <div class="grid-4 mt-1">
                        <div style="font-size: 0.75rem; color: #666;">
                            <strong>Legend:</strong> F=FT (40h/wk), P=PT (20h/wk)
                        </div>
                        <div style="font-size: 0.75rem;">
                            <strong>Efficiency:</strong> <span id="labor-efficiency-trend"></span>
                        </div>
                    </div>
                </div>

            <!-- VSP Staffing -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">VSP Staffing Requirements (FTE + Part-Time)</span>
                    <span class="card-subtitle">Max 2 FTE per location, remainder as PT. Compares required vs initial setup.</span>
                </div>
                
                <!-- Initial vs Required Staffing Comparison -->
                <div id="staffingComparison" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;"></div>
                
                <div class="table-scroll">
                    <table class="data-table" id="staffingTable">
                        <thead id="staffingTableHead">
                            <!-- Generated dynamically -->
                        </thead>
                        <tbody id="staffingTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Staffing Cost Analysis -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">üíµ Staffing Cost Analysis</span>
                    <span class="card-subtitle">Labor costs, revenue per staff hour, and break-even metrics</span>
                </div>
                <div class="grid-4" id="staffingCostCards">
                    <!-- Generated dynamically -->
                </div>
                <div class="mt-1">
                    <div class="table-scroll">
                        <table class="data-table" id="laborCostTable">
                            <thead>
                                <tr>
                                    <th>Studio</th>
                                    <th>Monthly Labor $</th>
                                    <th>Labor % Revenue</th>
                                    <th>Rev/Staff Hour</th>
                                    <th>Members/FTE</th>
                                    <th>Break-Even Util%</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="laborCostTableBody"></tbody>
                        </table>
                    </div>
                </div>
                <div class="legend-box mt-1">
                    <strong>Benchmarks:</strong>
                    <span class="legend-item">üü¢ Labor &lt;25% of revenue = Excellent</span>
                    <span class="legend-item">üü° 25-35% = Acceptable</span>
                    <span class="legend-item">üî¥ &gt;35% = Review needed</span>
                    <span class="legend-item">üìä Target: $80+ rev/staff hour</span>
                </div>
            </div>

            <!-- Utilization Chart -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Capacity Utilization Over Time</span>
                </div>
                <div class="chart-container">
                    <canvas id="utilizationChart"></canvas>
                </div>
            </div>

            <!-- Hiring Timeline -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Hiring Triggers</span>
                </div>
                <div id="hiringAlerts"></div>
            </div>
        </div>

        <!-- TAB: Scenarios -->
        <div class="tab-content" id="tab-scenarios">
            <div class="grid-4" id="scenarioCardsContainer">
                <!-- Conservative -->
                <div class="scenario-card conservative" id="scenario-conservative" onclick="applyPreset('conservative')" style="cursor: pointer;">
                    <div class="scenario-header">üê¢ Conservative</div>
                    <div class="scenario-body">
                        <div class="scenario-stat"><span>Ramp Growth</span><strong>8%</strong></div>
                        <div class="scenario-stat"><span>Churn</span><strong>5%</strong></div>
                        <div class="scenario-stat"><span>Conversion</span><strong>~18%</strong></div>
                        <hr style="margin: 0.75rem 0; border: none; border-top: 1px solid #eee;">
                        <div class="scenario-stat"><span id="scen-cons-month-label">Final Total</span><strong id="scen-cons-total">298</strong></div>
                        <div class="scenario-stat"><span>Monthly Revenue</span><strong id="scen-cons-rev">$44.7K</strong></div>
                        <div class="scenario-stat"><span>Net Profit</span><strong id="scen-cons-profit">$0</strong></div>
                        <div class="scenario-stat"><span>Studios @ Target</span><strong id="scen-cons-target">1/4</strong></div>
                    </div>
                </div>

                <!-- Moderate -->
                <div class="scenario-card moderate active" id="scenario-moderate" onclick="applyPreset('moderate')" style="cursor: pointer;">
                    <div class="scenario-header">‚öñÔ∏è Moderate</div>
                    <div class="scenario-body">
                        <div class="scenario-stat"><span>Ramp Growth</span><strong>12%</strong></div>
                        <div class="scenario-stat"><span>Churn</span><strong>4.5%</strong></div>
                        <div class="scenario-stat"><span>Conversion</span><strong>~21%</strong></div>
                        <hr style="margin: 0.75rem 0; border: none; border-top: 1px solid #eee;">
                        <div class="scenario-stat"><span id="scen-mod-month-label">Final Total</span><strong id="scen-mod-total">350</strong></div>
                        <div class="scenario-stat"><span>Monthly Revenue</span><strong id="scen-mod-rev">$52.5K</strong></div>
                        <div class="scenario-stat"><span>Net Profit</span><strong id="scen-mod-profit">$0</strong></div>
                        <div class="scenario-stat"><span>Studios @ Target</span><strong id="scen-mod-target">2/4</strong></div>
                    </div>
                </div>

                <!-- Aggressive -->
                <div class="scenario-card aggressive" id="scenario-aggressive" onclick="applyPreset('aggressive')" style="cursor: pointer;">
                    <div class="scenario-header">üöÄ Aggressive</div>
                    <div class="scenario-body">
                        <div class="scenario-stat"><span>Ramp Growth</span><strong>15%</strong></div>
                        <div class="scenario-stat"><span>Churn</span><strong>4%</strong></div>
                        <div class="scenario-stat"><span>Conversion</span><strong>~24%</strong></div>
                        <hr style="margin: 0.75rem 0; border: none; border-top: 1px solid #eee;">
                        <div class="scenario-stat"><span id="scen-agg-month-label">Final Total</span><strong id="scen-agg-total">587</strong></div>
                        <div class="scenario-stat"><span>Monthly Revenue</span><strong id="scen-agg-rev">$88.1K</strong></div>
                        <div class="scenario-stat"><span>Net Profit</span><strong id="scen-agg-profit">$0</strong></div>
                        <div class="scenario-stat"><span>Studios @ Target</span><strong id="scen-agg-target">4/4</strong></div>
                    </div>
                </div>

                <!-- Custom (Your Current) -->
                <div class="scenario-card custom" id="scenario-custom" style="cursor: default;">
                    <div class="scenario-header">üéØ Custom (Your Settings)</div>
                    <div class="scenario-body">
                        <div class="scenario-stat"><span>Ramp Growth</span><strong id="scen-custom-ramp">12%</strong></div>
                        <div class="scenario-stat"><span>Churn</span><strong id="scen-custom-churn">4.5%</strong></div>
                        <div class="scenario-stat"><span>Avg Conversion</span><strong id="scen-custom-conv">21%</strong></div>
                        <hr style="margin: 0.75rem 0; border: none; border-top: 1px solid #eee;">
                        <div class="scenario-stat"><span id="scen-custom-month-label">Final Total</span><strong id="scen-custom-total">415</strong></div>
                        <div class="scenario-stat"><span>Monthly Revenue</span><strong id="scen-custom-rev">$62.3K</strong></div>
                        <div class="scenario-stat"><span>Net Profit</span><strong id="scen-custom-profit">$0</strong></div>
                        <div class="scenario-stat"><span>Studios @ Target</span><strong id="scen-custom-target">2/4</strong></div>
                    </div>
                </div>
            </div>

            <!-- Scenario Chart -->
            <div class="card mt-2">
                <div class="card-header">
                    <span class="card-title">Scenario Comparison</span>
                </div>
                <div class="chart-container">
                    <canvas id="scenarioChart"></canvas>
                </div>
            </div>

            <!-- Sensitivity Analysis -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Sensitivity Analysis</span>
                    <span class="card-subtitle">Impact of +/- 1% change</span>
                </div>
                <div class="grid-2">
                    <div>
                        <h4 class="mb-1" style="font-size: 0.9rem; color: var(--blue);">If Churn Increases +1%</h4>
                        <div class="stat-box danger">
                            <div class="value" id="sens-churn-up">-32</div>
                            <div class="label">Members Lost Dec '26</div>
                        </div>
                    </div>
                    <div>
                        <h4 class="mb-1" style="font-size: 0.9rem; color: var(--blue);">If Growth Increases +1%</h4>
                        <div class="stat-box success">
                            <div class="value" id="sens-growth-up">+28</div>
                            <div class="label">Members Gained Dec '26</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Goal Seek -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Goal Seek Calculator</span>
                </div>
                <div class="grid-3">
                    <div class="form-group">
                        <label>I want total portfolio at Dec '26 to be:</label>
                        <input type="number" id="goal-seek-target" value="450">
                    </div>
                    <div class="stat-box info">
                        <div class="value" id="goal-seek-growth">18.2%</div>
                        <div class="label">Required Ramp Growth</div>
                    </div>
                    <div class="stat-box" id="goal-seek-feasibility">
                        <div class="value">Aggressive</div>
                        <div class="label">Feasibility</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: Franchise Setup -->
        <div class="tab-content" id="tab-franchise">
            <!-- Growth Rate Settings -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">üìä Growth Rate Settings</span>
                    <span class="card-subtitle">Set portfolio-wide growth assumptions ‚Ä¢ Industry benchmarks shown below</span>
                </div>
                <div class="grid-4">
                    <div class="slider-group">
                        <label>
                            <span>Ramp Growth (M1-9)</span>
                            <strong id="rampValue">15.0%</strong>
                        </label>
                        <input type="range" id="rampGrowth" min="5" max="25" value="15" step="0.5">
                        <div style="display: flex; justify-content: space-between; font-size: 0.7rem; color: var(--muted); margin-top: 0.25rem;">
                            <span>Industry: 8-15%</span>
                            <span style="color: var(--success);">Target: 12%+</span>
                        </div>
                    </div>
                    <div class="slider-group">
                        <label>
                            <span>Maintenance Growth</span>
                            <strong id="maintValue">6.0%</strong>
                        </label>
                        <input type="range" id="maintGrowth" min="3" max="15" value="6" step="0.5">
                        <div style="display: flex; justify-content: space-between; font-size: 0.7rem; color: var(--muted); margin-top: 0.25rem;">
                            <span>Industry: 3-6%</span>
                            <span style="color: var(--success);">Target: 5%+</span>
                        </div>
                    </div>
                    <div class="slider-group">
                        <label>
                            <span>Churn Rate</span>
                            <strong id="churnValue">4.0%</strong>
                        </label>
                        <input type="range" id="churnRate" min="1" max="8" value="4" step="0.5">
                        <div style="display: flex; justify-content: space-between; font-size: 0.7rem; color: var(--muted); margin-top: 0.25rem;">
                            <span>Industry: 4-7%</span>
                            <span style="color: var(--success);">Target: &lt;4%</span>
                        </div>
                    </div>
                    <div class="stat-box info">
                        <div class="value" id="netGrowth">11.0%</div>
                        <div class="label">Net Ramp Growth</div>
                        <div style="font-size: 0.65rem; color: var(--muted); margin-top: 0.25rem;">Ramp ‚àí Churn</div>
                    </div>
                </div>
            </div>

            <div class="grid-2">
                <!-- Revenue Settings -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">üíµ Revenue Settings</span>
                    </div>
                    <div class="form-group">
                        <label>Avg Revenue Per Hour</label>
                        <input type="number" id="rev-per-hour" value="91" step="1" class="highlight">
                        <small class="text-muted">$ charged per session hour</small>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Avg Sessions/Member/Month</label>
                            <input type="number" id="sessions-pm-rev" value="5" step="0.5">
                        </div>
                        <div class="form-group">
                            <label>Avg Session Length (min)</label>
                            <input type="number" id="session-length-rev" value="30" step="5">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Intro Session Price</label>
                            <input type="number" id="intro-price" value="29" step="1">
                        </div>
                        <div class="form-group">
                            <label>Retail/Add-on Per Member</label>
                            <input type="number" id="retail-pm" value="15" step="1">
                        </div>
                    </div>
                </div>

                <!-- Fees & Costs -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">üìã Fees & Cost Structure</span>
                    </div>
                    <div class="card-subtitle mb-1" style="font-weight: 600; color: var(--blue);">Fees (% of Gross Revenue)</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Royalty %</label>
                            <input type="number" id="fee-royalty" value="7" step="0.5" class="highlight">
                        </div>
                        <div class="form-group">
                            <label>Brand Fund %</label>
                            <input type="number" id="fee-brand" value="1.5" step="0.5" class="highlight">
                        </div>
                        <div class="form-group">
                            <label>Credit Card %</label>
                            <input type="number" id="fee-cc" value="2.9" step="0.1">
                        </div>
                        <div class="form-group">
                            <label>Momence %</label>
                            <input type="number" id="fee-momence" value="1" step="0.1">
                        </div>
                    </div>
                    <hr style="margin: 1rem 0; border: none; border-top: 1px solid #eee;">
                    <div class="card-subtitle mb-1" style="font-weight: 600; color: var(--blue);">Fixed Costs</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Other Fixed $/Studio/Mo</label>
                            <input type="number" id="other-fixed-costs" value="2500" step="100">
                        </div>
                        <div class="form-group">
                            <label>VSP Commission %</label>
                            <input type="number" id="vsp-commission" value="5" step="0.5" min="0" max="20">
                        </div>
                        <div class="form-group">
                            <label>Sessions/Member/Mo</label>
                            <input type="number" id="sessions-pm" value="5" step="0.5">
                        </div>
                        <div class="form-group">
                            <label>Session Length (min)</label>
                            <input type="number" id="session-length-fin" value="30" step="5">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>GM Salary</label>
                            <input type="number" id="gm-salary" value="5500" step="500" class="highlight">
                        </div>
                        <div class="form-group">
                            <label>Owner Draws (√ó2)</label>
                            <input type="number" id="owner-draws-total" value="2000" step="500" class="highlight">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Studio Cards -->
            <div class="grid-2" id="studioCardsContainer">
                <!-- Studio cards generated dynamically -->
            </div>

            <!-- Seasonality -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">üìÖ Seasonality Multipliers</span>
                    <span class="card-subtitle">Adjust new member acquisition by month</span>
                </div>
                <!-- Seasonality Visual Bar -->
                <div id="seasonalityVisual" style="display: grid; grid-template-columns: repeat(12, 1fr); gap: 4px; margin-bottom: 1rem;"></div>
                <div id="seasonalityInputs" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 0.75rem;"></div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="footer-tagline">Made with ‚ù§Ô∏è by bonJoeV</div>
    </footer>

    <script>
        // ==========================================
        // ‚öôÔ∏è CONFIGURATION - All adjustable constants in one place
        // ==========================================
        // To modify business rules or thresholds, edit values here.
        // These are referenced throughout the dashboard calculations.
        
        const CONFIG = {
            // --- Staffing Thresholds ---
            staffing: {
                maxFtePerStudio: 2,           // Maximum full-time employees per location
                maxPtPerStudio: 4,            // Maximum part-time employees per location
                fteHoursPerWeek: 40,          // Hours per week for full-time
                ptHoursPerWeek: 20,           // Hours per week for part-time
                utilThreshold: 0.80,          // 80% - trigger hiring when utilization exceeds this
                overstaffHighThreshold: 1.50, // 150%+ of required = highly overstaffed
                overstaffThreshold: 1.25,     // 125%+ of required = overstaffed
                tightThreshold: 0.80          // Below 80% of required = understaffed
            },
            
            // --- Conversion & Funnel ---
            conversion: {
                baselineConvRate: 0.24,       // 20% baseline conversion (35% L-I √ó 55% I-M)
                introToMemberRate: 0.55,      // 55% intro-to-member conversion
                leadToIntroDefault: 0.35,     // 35% lead-to-intro default
                lowConvScenarioFactor: 0.75   // What-if: reduce conversion by 25%
            },
            
            // --- Status Thresholds ---
            status: {
                targetWarningPct: 0.90,       // Show warning if at 90% of target
                breakEvenWarningPct: 0.80,    // Show warning if at 80% of break-even
                confidenceBandPct: 0.10       // ¬±10% confidence band on projections
            },
            
            // --- Growth & Timeline ---
            growth: {
                rampMonths: 9,                // Months in "ramp" phase before maintenance
                whatIfDelayMonths: 2,         // What-if scenario: delay opening by X months
                whatIfChurnIncrease: 2,       // What-if scenario: increase churn by X points
                maxChurnRate: 8               // Maximum churn rate in what-if scenarios
            },
            
            // --- Display & Formatting ---
            display: {
                seasonalityMin: 0.65,         // Minimum seasonality multiplier in dropdown
                seasonalityMax: 1.40,         // Maximum seasonality multiplier in dropdown
                seasonalityStep: 0.05         // Step increment for seasonality dropdown
            },
            
            // --- ROI & LTV Analysis ---
            roi: {
                avgMembershipMonths: 9,      // Average member lifespan for LTV calculation
                roasExcellent: 3.0,           // ROAS >= 3x = Excellent
                roasGood: 2.0,                // ROAS >= 2x = Good
                ltvCacExcellent: 3.0,         // LTV:CAC >= 3:1 = Excellent  
                ltvCacGood: 2.0,              // LTV:CAC >= 2:1 = Good
                leadGapOk: 5,                 // +5 lead surplus = consider reducing spend
                leadGapTight: -5              // -5 leads = slight increase needed
            }
        };

        // ==========================================
        // üè¢ STUDIO CONFIGURATION - Edit studio defaults here
        // ==========================================
        const STUDIO_IDS = ['eden', 'savage', 'slp', 'minnetonka'];
        const STUDIO_NAMES = { eden: 'Eden Prairie', savage: 'Savage', slp: 'St Louis Park', minnetonka: 'Minnetonka' };
        const STUDIO_COLORS = { eden: '#013160', savage: '#71BED2', slp: '#FBB514', minnetonka: '#4A90A4' };
        
        const DEFAULTS = {
            studios: {
                eden: {
                    current: 63, month: 6, target: 105,
                    sqft: 1335, nnn: 26.62,
                    tables: 5, hours: 12, days: 6, util: 55,
                    convLi: 25, convIm: 40, adSpend: 1000, adSpendAccel: 3500,  // Established: 25% √ó 40% = 10%
                    costPerLead: 26, vspStretch: 24, vspIdle: 14,  // Per-studio rates
                    badge: 'Opened Jul 2025', headerClass: 'eden',
                    initialStaff: { fte: 2, pt: 2 }
                },
                savage: {
                    current: 23, month: 2, target: 112,
                    sqft: 1262, nnn: 39.99,
                    tables: 4, hours: 12, days: 5, util: 60,
                    convLi: 26, convIm: 45, adSpend: 2000, adSpendAccel: 3500,  // Newer: 22% √ó 38% = 8.4%
                    costPerLead: 24, vspStretch: 23, vspIdle: 13,  // Per-studio rates
                    badge: 'Opened Nov 2025', headerClass: 'savage',
                    initialStaff: { fte: 2, pt: 2 }
                },
                slp: {
                    current: 25, month: 0, target: 125, opens: 3,
                    sqft: 1547, nnn: 51.00,
                    tables: 5, hours: 12, days: 6, util: 50,
                    convLi: 22, convIm: 40, adSpend: 3000, adSpendAccel: 5000,  // New: 20% √ó 35% = 7%
                    costPerLead: 22, vspStretch: 23, vspIdle: 13,  // Per-studio rates (new market)
                    badge: 'Opens Mar 2026', headerClass: 'slp',
                    opensOptions: [{v:1,t:'Jan 2026'},{v:2,t:'Feb 2026'},{v:3,t:'Mar 2026',s:true},{v:4,t:'Apr 2026'},{v:5,t:'May 2026'}],
                    initialStaff: { fte: 1, pt: 2 }
                },
                minnetonka: {
                    current: 25, month: 0, target: 105, opens: 5,
                    sqft: 1247, nnn: 41.39,
                    tables: 5, hours: 12, days: 6, util: 50,
                    convLi: 22, convIm: 40, adSpend: 3000, adSpendAccel: 5000,  // New: 20% √ó 35% = 7%
                    costPerLead: 21, vspStretch: 23, vspIdle: 13,  // Per-studio rates (new market)
                    badge: 'Opens May 2026', headerClass: 'minnetonka',
                    opensOptions: [{v:3,t:'Mar 2026'},{v:4,t:'Apr 2026'},{v:5,t:'May 2026',s:true},{v:6,t:'Jun 2026'}],
                    initialStaff: { fte: 1, pt: 2 }
                }
            },
            growth: {
                ramp: 15,      // % during months 1-9 (industry: 8-15%)
                maint: 5,      // % after month 9 (industry: 3-6%)
                churn: 5       // % monthly churn (industry: 4-7%, target <4%)
            },
            revenue: {
                revPerHour: 91,
                sessionsPm: 5,
                sessionLength: 30,  // minutes
                introPrice: 29,
                retailPm: 15
            },
            fees: {
                royalty: 7,
                brand: 1.5,
                cc: 2.9,
                momence: 1
            },
            costs: {
                otherFixed: 2550,
                vspCommission: 5,
                gmSalary: 6000,
                ownerDrawsTotal: 2000
            },
            leads: {
                costPerLead: 24
            },
            cash: {
                startingCash: 185000  // Starting cash on hand
            },
            seasonality: {
                1: 1.35, 2: 1.15, 3: 1.10, 4: 0.95,
                5: 0.90, 6: 0.85, 7: 0.80, 8: 0.85,
                9: 1.10, 10: 1.00, 11: 0.95, 12: 0.90
            }
        };

        // Global state - month constants
        const MONTH_NAMES = ['January', 'February', 'March', 'April', 'May', 'June', 
                             'July', 'August', 'September', 'October', 'November', 'December'];
        const MONTH_ABBREV = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        
        // Dynamic time horizon - default 13 months (Dec '25 to Dec '26)
        let timeHorizonMonths = 13;
        let months = [];
        let monthNumbers = [];
        
        function generateMonthArrays(numMonths) {
            months = [];
            monthNumbers = [];
            // Start from Dec 2025 (month 12, year 25)
            let month = 12;
            let year = 25;
            for (let i = 0; i < numMonths; i++) {
                months.push(`${MONTH_ABBREV[month - 1]}-${year}`);
                monthNumbers.push(month);
                month++;
                if (month > 12) {
                    month = 1;
                    year++;
                }
            }
        }
        
        // Initialize with default
        generateMonthArrays(timeHorizonMonths);
        
        function changeTimeHorizon(numMonths) {
            timeHorizonMonths = parseInt(numMonths);
            generateMonthArrays(timeHorizonMonths);
            regenerateTableHeaders();
            updateAll();
            showSaveNotification(`Time horizon changed to ${numMonths} months`);
        }
        
        let charts = {};
        let projectionData = {};

        // ==========================================
        // DYNAMIC HTML GENERATION
        // ==========================================
        
        // Generate/regenerate table headers based on current time horizon
        function regenerateTableHeaders() {
            const monthHeaders = months.map(m => `<th>${m}</th>`).join('');
            
            // Lead table
            setHtml('leadTableHead', `<tr><th>Metric</th>${monthHeaders}</tr>`);
            
            // Ad spend table  
            setHtml('adSpendTableHead', `<tr><th>Studio</th>${monthHeaders}</tr>`);
            
            // Finance table
            setHtml('financeTableHead', `<tr><th>Metric</th>${monthHeaders}</tr>`);
            
            // Staffing table
            setHtml('staffingTableHead', `<tr><th>Studio</th>${monthHeaders}</tr>`);
            
            // Update KPI labels with end month
            const endMonth = months[months.length - 1];
            document.querySelectorAll('.kpi-item .label').forEach(label => {
                if (label.textContent.includes("Dec '26") || label.textContent.includes("Dec '27") || label.textContent.includes("Dec '28")) {
                    label.textContent = label.textContent.replace(/Dec '\d{2}/, endMonth.replace('-', " '"));
                }
            });
        }
        
        // Get the final month index (last month in projection)
        function getFinalMonthIndex() {
            return months.length - 1;
        }
        
        function generateStudioCards() {
            const container = document.getElementById('studioCardsContainer');
            if (!container) return;
            
            container.innerHTML = STUDIO_IDS.map(id => {
                const def = DEFAULTS.studios[id];
                const name = STUDIO_NAMES[id];
                const isNewStudio = def.opens !== undefined;
                
                // Build opens select for new studios
                let monthField = '';
                if (isNewStudio) {
                    const options = def.opensOptions.map(opt => 
                        `<option value="${opt.v}"${opt.s ? ' selected' : ''}>${opt.t}</option>`
                    ).join('');
                    monthField = `
                        <div class="form-group">
                            <label>Opens In</label>
                            <select id="${id}-opens">${options}</select>
                        </div>`;
                } else {
                    monthField = `
                        <div class="form-group">
                            <label>Current Month #</label>
                            <input type="number" id="${id}-month" value="${def.month}">
                        </div>`;
                }
                
                return `
                <div class="card">
                    <div class="studio-header ${def.headerClass}">
                        <h3>${name}</h3>
                        <span class="studio-badge">${def.badge}</span>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>${isNewStudio ? 'Opening Members' : 'Current Members'}</label>
                            <input type="number" id="${id}-current" value="${def.current}" class="highlight">
                        </div>
                        ${monthField}
                        <div class="form-group">
                            <label>Month 9 Target</label>
                            <input type="number" id="${id}-target" value="${def.target}" class="highlight">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Square Feet</label>
                            <input type="number" id="${id}-sqft" value="${def.sqft}" class="highlight">
                        </div>
                        <div class="form-group">
                            <label>Lease + NNN Rate ($/sf/yr)</label>
                            <input type="number" id="${id}-nnn" value="${def.nnn}" step="0.01" class="highlight">
                        </div>
                        <div class="form-group">
                            <label>Monthly Rent</label>
                            <div class="stat-box" style="padding: 0.4rem; margin-top: 0.2rem;">
                                <div class="value" id="${id}-rent" style="font-size: 1.1rem;">$${Math.round(def.sqft * def.nnn / 12).toLocaleString()}</div>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Tables</label>
                            <input type="number" id="${id}-tables" value="${def.tables}">
                        </div>
                        <div class="form-group">
                            <label>Hours Open/Day</label>
                            <input type="number" id="${id}-hours" value="${def.hours}">
                        </div>
                        <div class="form-group">
                            <label>Days Open/Week</label>
                            <input type="number" id="${id}-days" value="${def.days}">
                        </div>
                        <div class="form-group">
                            <label>Utilization %</label>
                            <input type="number" id="${id}-util" value="${def.util}" step="5" class="highlight">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Lead‚ÜíIntro %</label>
                            <input type="number" id="${id}-conv-li" value="${def.convLi}" step="1">
                        </div>
                        <div class="form-group">
                            <label>Intro‚ÜíMember %</label>
                            <input type="number" id="${id}-conv-im" value="${def.convIm}" step="1">
                        </div>
                        <div class="form-group">
                            <label>Ad Spend/Mo</label>
                            <input type="number" id="${id}-adspend" value="${def.adSpend}" step="100" class="highlight">
                        </div>
                        <div class="form-group">
                            <label>Launch Spend/Mo</label>
                            <input type="number" id="${id}-adspend-accel" value="${def.adSpendAccel}" step="100" class="highlight" title="1 month before + first 3 months">
                            <small class="text-muted" style="font-size: 0.65rem;">Pre-open + M1-3</small>
                        </div>
                        <div class="form-group">
                            <label>Overall Conv.</label>
                            <div class="stat-box info" style="padding: 0.4rem; margin-top: 0.2rem;">
                                <div class="value" id="${id}-conv" style="font-size: 1.1rem;">${((def.convLi/100) * (def.convIm/100) * 100).toFixed(1)}%</div>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Cost Per Lead $</label>
                            <input type="number" id="${id}-cpl" value="${def.costPerLead}" step="1" class="highlight">
                        </div>
                        <div class="form-group">
                            <label>VSP Stretch $/hr</label>
                            <input type="number" id="${id}-vsp-stretch" value="${def.vspStretch}" step="0.5">
                        </div>
                        <div class="form-group">
                            <label>VSP Idle $/hr</label>
                            <input type="number" id="${id}-vsp-idle" value="${def.vspIdle}" step="0.5">
                        </div>
                        <div class="form-group">
                            <label>Blended Rate</label>
                            <div class="stat-box" style="padding: 0.4rem; margin-top: 0.2rem;">
                                <div class="value" id="${id}-blended-rate" style="font-size: 1.1rem;">$${((def.vspStretch * def.util/100) + (def.vspIdle * (1 - def.util/100))).toFixed(2)}</div>
                            </div>
                        </div>
                    </div>
                    <div class="grid-3 mt-1">
                        <div class="stat-box" id="${id}-projected-box">
                            <div class="value" id="${id}-projected">--</div>
                            <div class="label">Projected M9</div>
                        </div>
                        <div class="stat-box">
                            <div class="value" id="${id}-required">--</div>
                            <div class="label">Required Growth</div>
                        </div>
                        <div class="stat-box" id="${id}-final-box">
                            <div class="value" id="${id}-final">--</div>
                            <div class="label">Dec '26</div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }
        
        function generateConversionDisplays() {
            const container = document.getElementById('conversionDisplaysContainer');
            if (!container) return;
            
            container.innerHTML = STUDIO_IDS.map(id => {
                const def = DEFAULTS.studios[id];
                const name = STUDIO_NAMES[id];
                const hasLaunchSpend = def.adSpendAccel && def.adSpendAccel !== def.adSpend;
                return `
                <div class="stat-box">
                    <div class="value" id="${id}-conv-display">${((def.convLi/100) * (def.convIm/100) * 100).toFixed(1)}%</div>
                    <div class="label">${name}</div>
                    <div class="text-muted" style="font-size: 0.7rem;" id="${id}-adspend-display">$${def.adSpend.toLocaleString()}/mo</div>
                    ${hasLaunchSpend ? `<div class="text-muted" style="font-size: 0.65rem; color: var(--gold);" id="${id}-adspend-accel-display">Launch: $${def.adSpendAccel.toLocaleString()}/mo</div>` : ''}
                </div>`;
            }).join('');
        }
        
        function generateOpsUtilDisplays() {
            const container = document.getElementById('opsUtilContainer');
            if (!container) return;
            
            container.innerHTML = STUDIO_IDS.map(id => {
                const def = DEFAULTS.studios[id];
                const shortName = STUDIO_NAMES[id].split(' ')[0]; // First word only
                return `<div><strong>${shortName}:</strong> <span id="ops-${id}-util">${def.util}%</span></div>`;
            }).join('');
        }

        // Utility functions
        function getVal(id, def = 0) {
            const el = document.getElementById(id);
            return el ? (parseFloat(el.value) || def) : def;
        }

        function setHtml(id, val) {
            const el = document.getElementById(id);
            if (el) el.innerHTML = val;
        }

        function getSeasonality() {
            const s = {};
            for (let i = 1; i <= 12; i++) s[i] = getVal(`season-${i}`, DEFAULTS.seasonality[i]);
            return s;
        }

        function calcArpm() {
            const revPerHour = getVal('rev-per-hour', DEFAULTS.revenue.revPerHour);
            const sessionsPerMemberRev = getVal('sessions-pm-rev', DEFAULTS.revenue.sessionsPm);
            const sessionLengthRevMin = getVal('session-length-rev', DEFAULTS.revenue.sessionLength);
            const sessionLengthRevHrs = sessionLengthRevMin / 60;
            const retailPm = getVal('retail-pm', DEFAULTS.revenue.retailPm);
            return (revPerHour * sessionLengthRevHrs * sessionsPerMemberRev) + retailPm;
        }

        function formatCurrency(num) {
            if (num >= 1000) return '$' + (num / 1000).toFixed(1) + 'K';
            return '$' + num.toFixed(0);
        }

        // Core calculation - now uses conversion rate to influence growth
        function calculateStudio(startMembers, startMonthNum, ramp, maint, churn, seasonality, opensAtIdx = 0, convRate = 0.07, adSpend = 2500, cpl = DEFAULTS.leads.costPerLead) {
            const results = [];
            let members = startMembers;
            let currentMonth = startMonthNum;

            for (let i = 0; i < months.length; i++) {
                const monthIdx = monthNumbers[i];
                
                if (opensAtIdx > 0 && i < (opensAtIdx - 1)) {
                    results.push({ members: 0, monthNum: 0, newMembers: 0 });
                    continue;
                }

                if (opensAtIdx > 0 && i === (opensAtIdx - 1)) {
                    members = startMembers;
                    currentMonth = 1;
                }

                // Calculate base growth rate
                const baseGrowthRate = currentMonth <= CONFIG.growth.rampMonths ? ramp : maint;
                const seasonal = seasonality[monthIdx] || 1;
                
                // Calculate new members based on ad spend and conversion funnel
                // Lead‚ÜíIntro‚ÜíMember: leads from ad spend √ó (convLI √ó convIM)
                const leadsFromAds = Math.floor(adSpend / cpl);
                const newMembersFromFunnel = Math.round(leadsFromAds * convRate * seasonal);
                
                // Also consider organic growth (word of mouth, etc) scaled by conversion efficiency
                // Higher conversion rates mean better performance overall
                const conversionEfficiency = convRate / CONFIG.conversion.baselineConvRate;
                const organicNewMembers = Math.round(members * baseGrowthRate * seasonal * conversionEfficiency);
                
                // Total new members = funnel + organic, both influenced by conversion rate
                const newMembers = newMembersFromFunnel + organicNewMembers;
                
                const churned = Math.round(members * churn);
                members = Math.max(0, members + newMembers - churned);
                
                results.push({ members, monthNum: currentMonth, newMembers });
                currentMonth++;
            }
            return results;
        }

        function findMonth9Value(results) {
            for (let r of results) {
                if (r.monthNum === CONFIG.growth.rampMonths) return r.members;
            }
            return results[results.length - 1].members;
        }

        function calcRequiredGrowth(current, target, months) {
            if (months <= 0 || current <= 0) return 0;
            return Math.pow(target / current, 1 / months) - 1;
        }

        // Main update function
        function updateAll() {
            // Validate inputs first
            validateInputs();
            
            // Update seasonality visual
            updateSeasonalityVisual();
            
            const ramp = getVal('rampGrowth', DEFAULTS.growth.ramp) / 100;
            const maint = getVal('maintGrowth', DEFAULTS.growth.maint) / 100;
            const churn = getVal('churnRate', DEFAULTS.growth.churn) / 100;
            const seasonality = getSeasonality();

            // Update displays
            setHtml('rampValue', (ramp * 100).toFixed(1) + '%');
            setHtml('maintValue', (maint * 100).toFixed(1) + '%');
            setHtml('churnValue', (churn * 100).toFixed(1) + '%');
            setHtml('netGrowth', ((ramp - churn) * 100).toFixed(1) + '%');
            
            // Update Performance vs Benchmarks
            // Calculate months to reach 100 members at current ramp rate
            const monthsTo100 = ramp > 0 ? Math.ceil(Math.log(100 / 30) / Math.log(1 + ramp)) : 99;
            setHtml('bench-ramp', monthsTo100 + ' months');
            const rampBadge = document.getElementById('bench-ramp-badge');
            if (rampBadge) {
                if (monthsTo100 <= CONFIG.growth.rampMonths) {
                    rampBadge.textContent = 'Ambitious';
                    rampBadge.className = 'badge mt-1 warning';
                } else if (monthsTo100 <= 18) {
                    rampBadge.textContent = 'Good';
                    rampBadge.className = 'badge mt-1 success';
                } else {
                    rampBadge.textContent = 'Slow';
                    rampBadge.className = 'badge mt-1 danger';
                }
            }
            
            // Update churn benchmark
            setHtml('bench-churn', (churn * 100).toFixed(1) + '%');
            const churnBadge = document.getElementById('bench-churn-badge');
            if (churnBadge) {
                if (churn <= 0.04) {
                    churnBadge.textContent = 'Excellent';
                    churnBadge.className = 'badge mt-1 success';
                } else if (churn <= 0.05) {
                    churnBadge.textContent = 'Good';
                    churnBadge.className = 'badge mt-1 success';
                } else if (churn <= 0.07) {
                    churnBadge.textContent = 'Average';
                    churnBadge.className = 'badge mt-1 warning';
                } else {
                    churnBadge.textContent = 'High';
                    churnBadge.className = 'badge mt-1 danger';
                }
            }

            // Calculate per-studio rents and capacity
            const studioRents = {};
            const studioConv = {};
            const studioUtil = {};
            const studioAdSpend = {};
            const studioAdSpendAccel = {};
            const studioCapacity = {};
            STUDIO_IDS.forEach(id => {
                const def = DEFAULTS.studios[id];
                const sqft = getVal(`${id}-sqft`, def.sqft);
                const nnn = getVal(`${id}-nnn`, def.nnn);
                const rent = Math.round(sqft * nnn / 12);
                studioRents[id] = rent;
                setHtml(`${id}-rent`, '$' + rent.toLocaleString());

                const convLi = getVal(`${id}-conv-li`, def.convLi) / 100;
                const convIm = getVal(`${id}-conv-im`, def.convIm) / 100;
                studioConv[id] = convLi * convIm;
                setHtml(`${id}-conv`, (studioConv[id] * 100).toFixed(1) + '%');

                studioUtil[id] = getVal(`${id}-util`, def.util) / 100;
                studioAdSpend[id] = getVal(`${id}-adspend`, def.adSpend);
                studioAdSpendAccel[id] = getVal(`${id}-adspend-accel`, def.adSpendAccel);
                
                // Per-studio capacity settings
                studioCapacity[id] = {
                    tables: getVal(`${id}-tables`, def.tables),
                    hours: getVal(`${id}-hours`, def.hours),
                    days: getVal(`${id}-days`, def.days)
                };
                
                // Update blended rate display
                const vspStretch = getVal(`${id}-vsp-stretch`, def.vspStretch);
                const vspIdle = getVal(`${id}-vsp-idle`, def.vspIdle);
                const util = studioUtil[id];
                const blendedRate = (vspStretch * util) + (vspIdle * (1 - util));
                setHtml(`${id}-blended-rate`, '$' + blendedRate.toFixed(2));
            });
            projectionData.rents = studioRents;
            projectionData.conv = studioConv;
            projectionData.util = studioUtil;
            projectionData.adSpend = studioAdSpend;
            projectionData.adSpendAccel = studioAdSpendAccel;
            projectionData.capacity = studioCapacity;

            // Calculate per-studio CPL and weighted average
            const studioCpl = {};
            STUDIO_IDS.forEach(id => {
                const def = DEFAULTS.studios[id];
                studioCpl[id] = getVal(`${id}-cpl`, def.costPerLead);
            });
            projectionData.cpl = studioCpl;
            
            // Calculate weighted average CPL (by ad spend)
            const totalAdBudget = STUDIO_IDS.reduce((sum, id) => sum + studioAdSpend[id], 0);
            const weightedAvgCpl = totalAdBudget > 0 
                ? STUDIO_IDS.reduce((sum, id) => sum + (studioCpl[id] * studioAdSpend[id]), 0) / totalAdBudget
                : DEFAULTS.leads.costPerLead;
            setHtml('avg-cpl', '$' + Math.round(weightedAvgCpl));
            
            // Calculate all studios using loop
            const studioData = {};
            STUDIO_IDS.forEach(id => {
                const def = DEFAULTS.studios[id];
                const isNewStudio = def.opens !== undefined;
                const startMonth = isNewStudio ? 1 : getVal(`${id}-month`, def.month);
                const opensMonth = isNewStudio ? getVal(`${id}-opens`, def.opens) : 0;
                studioData[id] = calculateStudio(
                    getVal(`${id}-current`, def.current), startMonth,
                    ramp, maint, churn, seasonality, opensMonth,
                    studioConv[id], studioAdSpend[id], studioCpl[id]
                );
            });

            projectionData = { ...studioData, rents: studioRents, conv: studioConv, util: studioUtil, adSpend: studioAdSpend, adSpendAccel: studioAdSpendAccel, capacity: studioCapacity, cpl: studioCpl };

            const total = months.map((_, i) => 
                STUDIO_IDS.reduce((sum, id) => sum + (studioData[id][i]?.members || 0), 0)
            );
            projectionData.total = total;

            // Update studio cards
            STUDIO_IDS.forEach(id => {
                const def = DEFAULTS.studios[id];
                const isNewStudio = def.opens !== undefined;
                const startMonth = isNewStudio ? 1 : getVal(`${id}-month`, def.month);
                updateStudioCard(id, studioData[id], getVal(`${id}-target`, def.target), startMonth);
            });

            // Update KPIs
            const arpm = calcArpm();
            const finalIdx = getFinalMonthIndex();
            const totalFinal = total[finalIdx];
            setHtml('kpi-total-dec', totalFinal);
            setHtml('kpi-revenue', formatCurrency(totalFinal * arpm));

            const targetsHit = STUDIO_IDS.filter(id => 
                findMonth9Value(studioData[id]) >= getVal(`${id}-target`, DEFAULTS.studios[id].target)
            ).length;
            setHtml('kpi-studios-target', targetsHit + '/' + STUDIO_IDS.length);

            // Leads & VSPs - use average conversion for KPI (only open studios)
            const openStudios = STUDIO_IDS.filter(id => !DEFAULTS.studios[id].opens || getVal(`${id}-month`, 1) > 0);
            const avgConv = openStudios.length > 0 
                ? openStudios.reduce((sum, id) => sum + studioConv[id], 0) / openStudios.length 
                : 0.07;
            const newMembersThisMonth = openStudios.reduce((sum, id) => sum + (studioData[id]?.[0]?.newMembers || 0), 0);
            const leadsNeeded = Math.ceil(newMembersThisMonth / avgConv);
            setHtml('kpi-leads-needed', leadsNeeded);

            // Update all sections (VSP KPI will be updated in updateOperations)
            updateDashboard();
            updateLeadFunnel();
            updateFinancials();
            updateOperations();
            
            // Update VSP KPI after operations calculates staffing
            if (projectionData.staffing) {
                const finalIdx = getFinalMonthIndex();
                const totalStaff = STUDIO_IDS.reduce((sum, id) => {
                    return sum + (projectionData.staffing[id][finalIdx]?.total || 0);
                }, 0);
                setHtml('kpi-vsp-needed', totalStaff);
            }
            
            updateScenarios();
        }

        function updateStudioCard(id, data, target, startMonth) {
            const m9 = findMonth9Value(data);
            const final = data[getFinalMonthIndex()].members;
            const monthsToM9 = Math.max(1, CONFIG.growth.rampMonths - startMonth);
            const current = data[0].members || getVal(`${id}-current`);
            const required = calcRequiredGrowth(current, target, monthsToM9);

            setHtml(`${id}-projected`, m9);
            setHtml(`${id}-required`, (required * 100).toFixed(1) + '%');
            setHtml(`${id}-final`, final);

            const projBox = document.getElementById(`${id}-projected-box`);
            if (projBox) {
                projBox.className = 'stat-box ' + (m9 >= target ? 'success' : m9 >= target * CONFIG.status.targetWarningPct ? 'warning' : 'danger');
            }
        }

        function updateDashboard() {
            // Growth chart - build datasets dynamically
            if (charts.dashGrowth) charts.dashGrowth.destroy();
            const ctx = document.getElementById('dashGrowthChart')?.getContext('2d');
            if (ctx) {
                const studioDatasets = STUDIO_IDS.map(id => ({
                    label: STUDIO_NAMES[id],
                    data: projectionData[id].map(d => d.members || null),
                    borderColor: STUDIO_COLORS[id],
                    tension: 0.4,
                    fill: false
                }));
                studioDatasets.push({
                    label: 'Total',
                    data: projectionData.total,
                    borderColor: '#28a745',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: false
                });
                
                charts.dashGrowth = new Chart(ctx, {
                    type: 'line',
                    data: { labels: months, datasets: studioDatasets },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                });
            }

            // Revenue chart - Stacked by Studio
            if (charts.dashRevenue) charts.dashRevenue.destroy();
            const revCtx = document.getElementById('dashRevenueChart')?.getContext('2d');
            if (revCtx) {
                const arpm = calcArpm();
                const revenueDatasets = STUDIO_IDS.map(id => ({
                    label: STUDIO_NAMES[id],
                    data: projectionData[id].map(d => (d.members || 0) * arpm),
                    backgroundColor: STUDIO_COLORS[id],
                    stack: 'revenue'
                }));
                
                charts.dashRevenue = new Chart(revCtx, {
                    type: 'bar',
                    data: {
                        labels: months,
                        datasets: revenueDatasets
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        plugins: { legend: { position: 'bottom', labels: { boxWidth: 12 } } },
                        scales: {
                            x: { stacked: true },
                            y: { 
                                stacked: true,
                                ticks: { callback: v => '$' + (v/1000).toFixed(0) + 'K' }
                            }
                        }
                    }
                });
            }

            // Studio status cards
            const statusHtml = STUDIO_IDS.map(id => {
                const data = projectionData[id];
                const m9 = findMonth9Value(data);
                const target = getVal(`${id}-target`, DEFAULTS.studios[id].target);
                const pct = Math.min((m9 / target) * 100, 100);
                const status = m9 >= target ? 'success' : m9 >= target * CONFIG.status.targetWarningPct ? 'warning' : 'danger';
                return `
                    <div style="margin-bottom: 0.75rem;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 0.25rem;">
                            <span>${STUDIO_NAMES[id]}</span>
                            <span><strong>${m9}</strong> / ${target}</span>
                        </div>
                        <div class="progress-bar"><div class="fill ${status}" style="width: ${pct}%"></div></div>
                    </div>
                `;
            }).join('');
            setHtml('studioStatusCards', statusHtml);

            // Break-even bars - use per-studio costs and utilization
            const rents = projectionData.rents || Object.fromEntries(
                Object.entries(DEFAULTS.studios).map(([id, s]) => [id, Math.round(s.sqft * s.nnn / 12)])
            );
            const utils = projectionData.util || Object.fromEntries(
                Object.entries(DEFAULTS.studios).map(([id, s]) => [id, s.util / 100])
            );
            const adSpendData = projectionData.adSpend || Object.fromEntries(
                Object.entries(DEFAULTS.studios).map(([id, s]) => [id, s.adSpend])
            );
            const otherFixed = getVal('other-fixed-costs', DEFAULTS.costs.otherFixed);
            const vspCommission = getVal('vsp-commission', DEFAULTS.costs.vspCommission) / 100;
            const sessionsPm = getVal('sessions-pm', DEFAULTS.revenue.sessionsPm);
            const sessionLengthMin = getVal('session-length-fin', DEFAULTS.revenue.sessionLength);
            const sessionLengthHrs = sessionLengthMin / 60;
            const arpm = calcArpm();
            
            // Management costs spread across active studios
            const gmSalary = getVal('gm-salary', DEFAULTS.costs.gmSalary);
            const ownerDraws = getVal('owner-draws-total', DEFAULTS.costs.ownerDrawsTotal);
            const totalMgmtCost = gmSalary + ownerDraws;
            
            // Count active studios for management cost allocation
            const activeStudioCount = STUDIO_IDS.filter(id => 
                projectionData[id][0].members > 0
            ).length || 2; // Default to 2 if none active yet
            const mgmtPerStudio = totalMgmtCost / activeStudioCount;
            
            const beHtml = STUDIO_IDS.map(id => {
                const current = projectionData[id][0].members;
                const studioFixed = rents[id] + otherFixed + adSpendData[id] + mgmtPerStudio;
                const util = utils[id];
                
                // Get per-studio VSP rates
                const vspStretch = getVal(`${id}-vsp-stretch`, DEFAULTS.studios[id].vspStretch);
                const vspIdle = getVal(`${id}-vsp-idle`, DEFAULTS.studios[id].vspIdle);
                
                // Labor cost per member at this studio's utilization + commission
                const sessionHours = sessionsPm * sessionLengthHrs;
                const totalVspHours = sessionHours / util;
                const laborPerMember = (sessionHours * vspStretch) + ((totalVspHours - sessionHours) * vspIdle);
                const commissionPerMember = arpm * vspCommission;
                const contribMargin = arpm - laborPerMember - commissionPerMember;
                
                const studioBreakEven = Math.ceil(studioFixed / contribMargin);
                const pct = Math.min((current / studioBreakEven) * 100, 100);
                const status = current >= studioBreakEven ? 'success' : current >= studioBreakEven * CONFIG.status.breakEvenWarningPct ? 'warning' : 'info';
                const utilDisplay = Math.round(util * 100) + '% util';
                return `
                    <div style="margin-bottom: 0.75rem;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 0.25rem;">
                            <span>${STUDIO_NAMES[id]} <span class="text-muted" style="font-size: 0.75rem;">(${utilDisplay})</span></span>
                            <span>${current} / ${studioBreakEven} members</span>
                        </div>
                        <div class="progress-bar"><div class="fill ${status}" style="width: ${pct}%"></div></div>
                    </div>
                `;
            }).join('');
            setHtml('breakEvenBars', beHtml);
            setHtml('breakEvenBarsFinancials', beHtml);
        }

        function updateLeadFunnel() {
            const defaultConv = DEFAULTS.studios.eden.convLi/100 * DEFAULTS.studios.eden.convIm/100;
            const conv = projectionData.conv || Object.fromEntries(STUDIO_IDS.map(id => [id, defaultConv]));
            const adSpend = projectionData.adSpend || Object.fromEntries(
                STUDIO_IDS.map(id => [id, DEFAULTS.studios[id].adSpend])
            );
            const cpl = getVal('cost-per-lead', DEFAULTS.leads.costPerLead);
            
            // Update per-studio conversion and ad spend displays
            STUDIO_IDS.forEach(id => {
                setHtml(`${id}-conv-display`, (conv[id] * 100).toFixed(1) + '%');
                setHtml(`${id}-adspend-display`, '$' + adSpend[id].toLocaleString() + '/mo ads');
            });
            
            // Calculate total active ad budget
            const currentAdBudget = STUDIO_IDS.reduce((sum, id) => 
                sum + (projectionData[id][0].members > 0 ? adSpend[id] : 0), 0
            );
            setHtml('total-ad-budget', '$' + currentAdBudget.toLocaleString());
            
            // Average conversion for display - include studios that are active by end of projection
            const finalIdx = getFinalMonthIndex();
            const activeConvs = STUDIO_IDS.filter(id => 
                projectionData[id][finalIdx].members > 0
            ).map(id => conv[id]);
            const avgConv = activeConvs.reduce((a, b) => a + b, 0) / activeConvs.length;
            const cac = cpl / avgConv;

            setHtml('conv-overall', (avgConv * 100).toFixed(1) + '%');
            setHtml('cac', '$' + Math.round(cac));
            setHtml('bench-conv', (avgConv * 100).toFixed(1) + '%');
            
            // Update conversion badge
            const convBadge = document.getElementById('bench-conv-badge');
            if (convBadge) {
                if (avgConv >= 0.20) {
                    convBadge.textContent = 'Excellent';
                    convBadge.className = 'badge mt-1 success';
                } else if (avgConv >= 0.15) {
                    convBadge.textContent = 'Good';
                    convBadge.className = 'badge mt-1 success';
                } else if (avgConv >= 0.10) {
                    convBadge.textContent = 'On Track';
                    convBadge.className = 'badge mt-1 warning';
                } else {
                    convBadge.textContent = 'Low';
                    convBadge.className = 'badge mt-1 danger';
                }
            }

            // Lead table with per-studio conversion rates - show Leads AND Intros
            
            // Calculate leads and intros per studio per month
            const studioLeads = {};
            const studioIntros = {};
            STUDIO_IDS.forEach(id => {
                const data = projectionData[id];
                const studioConv = conv[id] || (DEFAULTS.studios[id].convLi/100 * DEFAULTS.studios[id].convIm/100);
                const convLi = getVal(`${id}-conv-li`, DEFAULTS.studios[id].convLi) / 100;
                
                studioLeads[id] = data.map(d => {
                    if (d.members === 0) return 0;
                    return Math.ceil(d.newMembers / studioConv);
                });
                studioIntros[id] = data.map((d, i) => {
                    if (d.members === 0) return 0;
                    return Math.ceil(studioLeads[id][i] * convLi);
                });
            });

            // Build table rows - Leads
            let leadRows = STUDIO_IDS.map(id => {
                const cells = studioLeads[id].map(l => l > 0 ? l : '-');
                return `<tr><td>${STUDIO_NAMES[id]} - Leads</td>${cells.map(c => `<td>${c}</td>`).join('')}</tr>`;
            });

            // Total Leads row
            const totalLeads = months.map((_, i) => 
                STUDIO_IDS.reduce((sum, id) => sum + studioLeads[id][i], 0)
            );
            leadRows.push(`<tr class="total-row" style="background: #e3f2fd;"><td>TOTAL LEADS NEEDED</td>${totalLeads.map(l => `<td>${l}</td>`).join('')}</tr>`);

            // Add Intros rows
            leadRows.push(`<tr><td colspan="14" style="background: #f5f5f5; font-weight: 600; padding: 0.5rem;">Intros to Book</td></tr>`);
            STUDIO_IDS.forEach(id => {
                const cells = studioIntros[id].map(i => i > 0 ? i : '-');
                leadRows.push(`<tr><td>${STUDIO_NAMES[id]} - Intros</td>${cells.map(c => `<td>${c}</td>`).join('')}</tr>`);
            });

            // Total Intros row
            const totalIntros = months.map((_, i) => 
                STUDIO_IDS.reduce((sum, id) => sum + studioIntros[id][i], 0)
            );
            leadRows.push(`<tr class="total-row" style="background: #e8f5e9;"><td>TOTAL INTROS NEEDED</td>${totalIntros.map(i => `<td>${i}</td>`).join('')}</tr>`);

            // Add Ad Spend ‚Üí Leads Affordable section
            leadRows.push(`<tr><td colspan="14" style="background: #f5f5f5; font-weight: 600; padding: 0.5rem;">Ad Spend Analysis (Budget vs Need)</td></tr>`);
            
            // Get accelerated spend values
            const adSpendAccel = projectionData.adSpendAccel || Object.fromEntries(
                STUDIO_IDS.map(id => [id, DEFAULTS.studios[id].adSpendAccel || DEFAULTS.studios[id].adSpend])
            );
            
            STUDIO_IDS.forEach(id => {
                const def = DEFAULTS.studios[id];
                const isNewStudio = def.opens !== undefined;
                const opensMonth = isNewStudio ? getVal(`${id}-opens`, def.opens) : 0;
                
                const cells = studioLeads[id].map((needed, i) => {
                    if (needed === 0) return '-';
                    
                    // Determine budget for this month (accelerated vs normal)
                    const currentMonthNum = projectionData[id][i].monthNum || 0;
                    let isAccelPeriod = false;
                    if (isNewStudio) {
                        isAccelPeriod = (i >= opensMonth - 2 && i < opensMonth) || (currentMonthNum >= 1 && currentMonthNum <= 3);
                    } else {
                        // Existing studio - in accelerated period if month <= 3
                        isAccelPeriod = currentMonthNum >= 1 && currentMonthNum <= 3;
                    }
                    const monthBudget = isAccelPeriod ? adSpendAccel[id] : adSpend[id];
                    const leadsAffordable = Math.floor(monthBudget / cpl);
                    
                    const surplus = leadsAffordable - needed;
                    const color = surplus >= 0 ? '#28a745' : '#dc3545';
                    const sign = surplus >= 0 ? '+' : '';
                    return `<span style="color: ${color}">${sign}${surplus}</span>`;
                });
                leadRows.push(`<tr><td>${STUDIO_NAMES[id]} - Lead Surplus/Deficit</td>${cells.map(c => `<td>${c}</td>`).join('')}</tr>`);
            });

            // Total budget vs need - use accelerated spend for pre-open + first 2 months
            const totalAdBudget = months.map((_, i) => {
                return STUDIO_IDS.reduce((budget, id) => {
                    const def = DEFAULTS.studios[id];
                    const isNewStudio = def.opens !== undefined;
                    const opensMonth = isNewStudio ? getVal(`${id}-opens`, def.opens) : 0;
                    const currentMonthNum = projectionData[id][i].monthNum || 0;
                    
                    // Determine if this is an accelerated period
                    let isAccelPeriod = false;
                    if (isNewStudio) {
                        isAccelPeriod = (i >= opensMonth - 2 && i < opensMonth) || (currentMonthNum >= 1 && currentMonthNum <= 3);
                    } else {
                        // Existing studio - in accelerated period if month <= 3
                        isAccelPeriod = currentMonthNum >= 1 && currentMonthNum <= 3;
                    }
                    
                    if (projectionData[id][i].members > 0) {
                        return budget + (isAccelPeriod ? adSpendAccel[id] : adSpend[id]);
                    } else if (isNewStudio && i >= opensMonth - 2) {
                        return budget + adSpendAccel[id];
                    }
                    return budget;
                }, 0);
            });
            const totalLeadsAffordable = totalAdBudget.map(b => Math.floor(b / cpl));
            const leadSurplus = totalLeads.map((needed, i) => totalLeadsAffordable[i] - needed);
            
            leadRows.push(`<tr class="total-row"><td>TOTAL Lead Surplus/Deficit</td>${leadSurplus.map(s => {
                const color = s >= 0 ? '#28a745' : '#dc3545';
                const sign = s >= 0 ? '+' : '';
                return `<td style="color: ${color}; font-weight: 600;">${sign}${s}</td>`;
            }).join('')}</tr>`);

            setHtml('leadTableBody', leadRows.join(''));

            // Weekly targets - show leads, intros, and budget status
            const thisMonthLeads = totalLeads[0];
            const thisMonthIntros = totalIntros[0];
            const thisMonthBudget = totalAdBudget[0];
            const thisMonthAffordable = Math.floor(thisMonthBudget / cpl);
            const budgetStatus = thisMonthAffordable >= thisMonthLeads ? 'success' : 'danger';
            const budgetLabel = thisMonthAffordable >= thisMonthLeads ? 'Budget OK' : 'Budget Short';
            
            const weeklyHtml = `
                <div class="stat-box">
                    <div class="value">${Math.ceil(thisMonthLeads / 4)}</div>
                    <div class="label">Leads/Week Target</div>
                </div>
                <div class="stat-box">
                    <div class="value">${Math.ceil(thisMonthIntros / 4)}</div>
                    <div class="label">Intros/Week Target</div>
                </div>
                <div class="stat-box ${budgetStatus}">
                    <div class="value">${thisMonthAffordable}</div>
                    <div class="label">Leads Affordable @ $${cpl}/lead</div>
                </div>
                <div class="stat-box ${budgetStatus}">
                    <div class="value">${budgetLabel}</div>
                    <div class="label">${thisMonthAffordable - thisMonthLeads >= 0 ? '+' : ''}${thisMonthAffordable - thisMonthLeads} lead margin</div>
                </div>
            `;
            setHtml('weeklyTargets', weeklyHtml);

            // Marketing spend chart - show budget vs cost to generate needed leads
            if (charts.marketing) charts.marketing.destroy();
            const ctx = document.getElementById('marketingChart')?.getContext('2d');
            if (ctx) {
                const leadsNeededCost = totalLeads.map(l => l * cpl);
                charts.marketing = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: months,
                        datasets: [
                            { label: 'Ad Budget', data: totalAdBudget, backgroundColor: '#71BED2' },
                            { label: 'Cost for Leads Needed', data: leadsNeededCost, backgroundColor: 'rgba(220, 53, 69, 0.5)', borderColor: '#dc3545', borderWidth: 1 }
                        ]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        plugins: { 
                            legend: { display: true, position: 'bottom' },
                            tooltip: {
                                callbacks: {
                                    afterBody: function(context) {
                                        const idx = context[0].dataIndex;
                                        const diff = totalAdBudget[idx] - leadsNeededCost[idx];
                                        return diff >= 0 ? `Surplus: $${diff}` : `Shortfall: $${Math.abs(diff)}`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Funnel chart
            const avgNewMembers = Math.round(totalLeads.reduce((a, b) => a + b, 0) / 13 * avgConv);
            const avgIntros = Math.round(avgNewMembers / CONFIG.conversion.introToMemberRate);
            const avgLeadsNum = Math.round(totalLeads.reduce((a, b) => a + b, 0) / 13);
            if (charts.funnel) charts.funnel.destroy();
            const funnelCtx = document.getElementById('funnelChart')?.getContext('2d');
            if (funnelCtx) {
                charts.funnel = new Chart(funnelCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Leads', 'Intros Booked', 'New Members'],
                        datasets: [{ data: [avgLeadsNum, avgIntros, avgNewMembers], backgroundColor: ['#013160', '#71BED2', '#28a745'] }]
                    },
                    options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
            }

            // ==========================================
            // ROI CALCULATOR - ROAS & LTV:CAC by Studio
            // ==========================================
            const arpmForRoi = calcArpm();
            const avgMembershipMonths = CONFIG.roi.avgMembershipMonths;
            const ltv = arpmForRoi * avgMembershipMonths;
            
            const roiCardsHtml = STUDIO_IDS.map(id => {
                const def = DEFAULTS.studios[id];
                const name = STUDIO_NAMES[id];
                const studioConvRate = conv[id] || (def.convLi/100 * def.convIm/100);
                const studioSpend = adSpend[id];
                
                // CAC = CPL / conversion rate
                const studioCac = cpl / studioConvRate;
                
                // LTV:CAC ratio
                const ltvCacRatio = ltv / studioCac;
                
                // ROAS = Revenue generated per $ spent on ads (first year)
                // Members acquired per month = (ad spend / CPL) * conv rate
                const monthlyMembersFromAds = (studioSpend / cpl) * studioConvRate;
                const yearlyRevenueFromAds = monthlyMembersFromAds * arpmForRoi * 12;
                const yearlyAdSpend = studioSpend * 12;
                const roas = yearlyRevenueFromAds / yearlyAdSpend;
                
                // Status colors using CONFIG thresholds
                let roasStatus = 'danger';
                let roasLabel = 'Review';
                if (roas >= CONFIG.roi.roasExcellent) { roasStatus = 'success'; roasLabel = 'Excellent'; }
                else if (roas >= CONFIG.roi.roasGood) { roasStatus = 'warning'; roasLabel = 'Good'; }
                
                let ltvStatus = 'danger';
                if (ltvCacRatio >= CONFIG.roi.ltvCacExcellent) ltvStatus = 'success';
                else if (ltvCacRatio >= CONFIG.roi.ltvCacGood) ltvStatus = 'warning';
                
                return `
                    <div class="stat-box">
                        <div class="label" style="font-weight: 600; margin-bottom: 0.5rem;">${name}</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; text-align: center;">
                            <div>
                                <div class="value" style="font-size: 1.2rem; color: var(--${roasStatus === 'warning' ? 'gold' : roasStatus});">${roas.toFixed(1)}x</div>
                                <div class="label">ROAS</div>
                            </div>
                            <div>
                                <div class="value" style="font-size: 1.2rem; color: var(--${ltvStatus === 'warning' ? 'gold' : ltvStatus});">${ltvCacRatio.toFixed(1)}:1</div>
                                <div class="label">LTV:CAC</div>
                            </div>
                        </div>
                        <div style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--muted);">
                            CAC: $${Math.round(studioCac)} | Conv: ${(studioConvRate * 100).toFixed(0)}%
                        </div>
                        <span class="badge ${roasStatus}" style="margin-top: 0.25rem;">${roasLabel}</span>
                    </div>
                `;
            }).join('');
            setHtml('roiCards', roiCardsHtml);

            // ==========================================
            // AD SPEND RECOMMENDATIONS by Studio - Month by Month
            // ==========================================
            const adSpendRows = STUDIO_IDS.map(id => {
                const def = DEFAULTS.studios[id];
                const name = STUDIO_NAMES[id];
                const isNewStudio = def.opens !== undefined;
                const opensMonth = isNewStudio ? getVal(`${id}-opens`, def.opens) : 0;
                const currentNormalSpend = adSpend[id];
                const currentAccelSpend = adSpendAccel[id];
                
                const cells = studioLeads[id].map((leadsNeeded, i) => {
                    const currentMonthNum = projectionData[id][i].monthNum || 0;
                    
                    // Determine if this is an accelerated period
                    let isAccelPeriod = false;
                    if (isNewStudio) {
                        isAccelPeriod = (i >= opensMonth - 2 && i < opensMonth) || (currentMonthNum >= 1 && currentMonthNum <= 3);
                    } else {
                        isAccelPeriod = currentMonthNum >= 1 && currentMonthNum <= 3;
                    }
                    
                    // Current budget for this month
                    const currentBudget = isAccelPeriod ? currentAccelSpend : currentNormalSpend;
                    
                    // If studio not active and not in pre-launch
                    if (leadsNeeded === 0 && !(isNewStudio && i >= opensMonth - 2 && i < opensMonth)) {
                        return '<td style="color: #999;">-</td>';
                    }
                    
                    // Calculate recommended spend
                    const recommendedSpend = Math.ceil(leadsNeeded * cpl);
                    const leadsAffordable = Math.floor(currentBudget / cpl);
                    const gap = leadsAffordable - leadsNeeded;
                    
                    // Determine status
                    let bgColor = '';
                    let textColor = 'inherit';
                    let displayValue = '';
                    
                    if (leadsNeeded === 0 && isNewStudio && i >= opensMonth - 2) {
                        // Pre-launch period - show accelerated spend
                        displayValue = `$${(currentAccelSpend/1000).toFixed(1)}K`;
                        bgColor = '#fff3cd';
                        textColor = '#856404';
                    } else if (gap >= CONFIG.roi.leadGapOk) {
                        // Surplus - could reduce
                        displayValue = `$${(recommendedSpend/1000).toFixed(1)}K`;
                        textColor = 'var(--info)';
                        bgColor = isAccelPeriod ? '#fff3cd' : '';
                    } else if (gap >= 0) {
                        // On target
                        displayValue = `$${(currentBudget/1000).toFixed(1)}K`;
                        textColor = 'var(--success)';
                        bgColor = isAccelPeriod ? '#fff3cd' : '';
                    } else {
                        // Need more
                        displayValue = `$${(recommendedSpend/1000).toFixed(1)}K`;
                        textColor = 'var(--danger)';
                        bgColor = isAccelPeriod ? '#fff3cd' : '';
                    }
                    
                    const title = `Current: $${currentBudget.toLocaleString()} | Need: ${leadsNeeded} leads | Can afford: ${leadsAffordable} leads | Gap: ${gap >= 0 ? '+' : ''}${gap}`;
                    
                    return `<td style="color: ${textColor}; font-weight: 500; background: ${bgColor};" title="${title}">${displayValue}</td>`;
                });
                
                return `<tr><td><strong>${name}</strong></td>${cells.join('')}</tr>`;
            }).join('');
            
            // Total recommended row
            const totalRecommendedByMonth = months.map((_, i) => {
                let totalRec = 0;
                STUDIO_IDS.forEach(id => {
                    const leadsNeeded = studioLeads[id][i];
                    if (leadsNeeded > 0) {
                        totalRec += Math.ceil(leadsNeeded * cpl);
                    } else {
                        // Check if pre-launch
                        const def = DEFAULTS.studios[id];
                        const isNewStudio = def.opens !== undefined;
                        const opensMonth = isNewStudio ? getVal(`${id}-opens`, def.opens) : 0;
                        if (isNewStudio && i >= opensMonth - 2 && i < opensMonth) {
                            totalRec += adSpendAccel[id];
                        }
                    }
                });
                return totalRec;
            });
            
            const totalRow = `<tr class="total-row" style="background: #e3f2fd;">
                <td><strong>TOTAL Recommended</strong></td>
                ${totalRecommendedByMonth.map(t => `<td><strong>$${(t/1000).toFixed(1)}K</strong></td>`).join('')}
            </tr>`;
            
            // Current budget row for comparison
            const currentBudgetByMonth = months.map((_, i) => {
                return STUDIO_IDS.reduce((sum, id) => {
                    const def = DEFAULTS.studios[id];
                    const isNewStudio = def.opens !== undefined;
                    const opensMonth = isNewStudio ? getVal(`${id}-opens`, def.opens) : 0;
                    const currentMonthNum = projectionData[id][i].monthNum || 0;
                    
                    let isAccelPeriod = false;
                    if (isNewStudio) {
                        isAccelPeriod = (i >= opensMonth - 2 && i < opensMonth) || (currentMonthNum >= 1 && currentMonthNum <= 3);
                    } else {
                        isAccelPeriod = currentMonthNum >= 1 && currentMonthNum <= 3;
                    }
                    
                    if (projectionData[id][i].members > 0 || (isNewStudio && i >= opensMonth - 2)) {
                        return sum + (isAccelPeriod ? adSpendAccel[id] : adSpend[id]);
                    }
                    return sum;
                }, 0);
            });
            
            const currentRow = `<tr style="background: #f8f9fa;">
                <td><strong>Current Budget</strong></td>
                ${currentBudgetByMonth.map(t => `<td>$${(t/1000).toFixed(1)}K</td>`).join('')}
            </tr>`;
            
            // Difference row
            const diffRow = `<tr>
                <td><strong>Difference</strong></td>
                ${currentBudgetByMonth.map((curr, i) => {
                    const diff = curr - totalRecommendedByMonth[i];
                    const color = diff >= 0 ? 'var(--success)' : 'var(--danger)';
                    return `<td style="color: ${color}; font-weight: 600;">${diff >= 0 ? '+' : ''}$${(diff/1000).toFixed(1)}K</td>`;
                }).join('')}
            </tr>`;
            
            setHtml('adSpendRecommendationBody', adSpendRows + totalRow + currentRow + diffRow);
        }

        function updateFinancials() {
            // Revenue - calculated from hourly rate
            const arpm = calcArpm();
            setHtml('calc-arpm', '$' + Math.round(arpm));
            
            // Fee percentages (deducted from gross revenue)
            const feeRoyalty = getVal('fee-royalty', DEFAULTS.fees.royalty) / 100;
            const feeBrand = getVal('fee-brand', DEFAULTS.fees.brand) / 100;
            const feeCC = getVal('fee-cc', DEFAULTS.fees.cc) / 100;
            const feeMomence = getVal('fee-momence', DEFAULTS.fees.momence) / 100;
            const totalFeePct = feeRoyalty + feeBrand + feeCC + feeMomence;
            setHtml('total-fee-pct', Math.round(totalFeePct * 100) + '%');
            
            // Cost inputs
            const otherFixed = getVal('other-fixed-costs', DEFAULTS.costs.otherFixed);
            const vspCommission = getVal('vsp-commission', DEFAULTS.costs.vspCommission) / 100; // % of revenue
            const sessionsPm = getVal('sessions-pm', DEFAULTS.costs.sessionsPm);
            const sessionLengthMin = getVal('session-length-fin', DEFAULTS.costs.sessionLength);
            const sessionLengthHrs = sessionLengthMin / 60;

            // Management & Owner compensation
            const gmSalary = getVal('gm-salary', DEFAULTS.costs.gmSalary);
            const ownerDraws = getVal('owner-draws-total', DEFAULTS.costs.ownerDrawsTotal);
            const totalMgmtCost = gmSalary + ownerDraws;
            setHtml('total-mgmt-cost', '$' + totalMgmtCost.toLocaleString());

            const rents = projectionData.rents || Object.fromEntries(
                STUDIO_IDS.map(id => [id, DEFAULTS.studios[id].sqft * DEFAULTS.studios[id].nnn / 12])
            );
            const utils = projectionData.util || Object.fromEntries(
                STUDIO_IDS.map(id => [id, DEFAULTS.studios[id].util / 100])
            );
            const adSpend = projectionData.adSpend || Object.fromEntries(
                STUDIO_IDS.map(id => [id, DEFAULTS.studios[id].adSpend])
            );
            
            // Get per-studio VSP rates
            const vspRates = Object.fromEntries(
                STUDIO_IDS.map(id => [id, {
                    stretch: getVal(`${id}-vsp-stretch`, DEFAULTS.studios[id].vspStretch),
                    idle: getVal(`${id}-vsp-idle`, DEFAULTS.studios[id].vspIdle)
                }])
            );
            
            // Calculate blended VSP rate per studio
            // Blended = (stretch rate √ó util%) + (idle rate √ó (1-util%))
            const blendedRates = {};
            STUDIO_IDS.forEach(id => {
                blendedRates[id] = (vspRates[id].stretch * utils[id]) + (vspRates[id].idle * (1 - utils[id]));
            });

            // Calculate total rent for active studios
            const totalRent = months.map((_, i) => 
                STUDIO_IDS.reduce((sum, id) => sum + (projectionData[id][i].members > 0 ? rents[id] : 0), 0)
            );

            // Calculate total ad spend for active studios
            // Use accelerated spend for: 1 month before open + first 3 months of operation
            const adSpendAccel = projectionData.adSpendAccel || Object.fromEntries(
                STUDIO_IDS.map(id => [id, DEFAULTS.studios[id].adSpendAccel || DEFAULTS.studios[id].adSpend])
            );
            const totalAdSpend = months.map((_, i) => {
                return STUDIO_IDS.reduce((spend, id) => {
                    const def = DEFAULTS.studios[id];
                    const isNewStudio = def.opens !== undefined;
                    const opensMonth = isNewStudio ? getVal(`${id}-opens`, def.opens) : 0;
                    const currentMonthNum = projectionData[id][i].monthNum || 0;
                    
                    // Determine if this is an accelerated period
                    // For new studios: 1 month before open + first 3 months of operation
                    // For existing studios: check if current month <= 3
                    let isAccelPeriod = false;
                    if (isNewStudio) {
                        // Pre-opening month OR first 3 months of operation
                        isAccelPeriod = (i >= opensMonth - 2 && i < opensMonth) || (currentMonthNum >= 1 && currentMonthNum <= 3);
                    } else {
                        // Existing studio - in accelerated period if month <= 3
                        isAccelPeriod = currentMonthNum >= 1 && currentMonthNum <= 3;
                    }
                    
                    if (projectionData[id][i].members > 0) {
                        return spend + (isAccelPeriod ? adSpendAccel[id] : adSpend[id]);
                    } else if (isNewStudio && i >= opensMonth - 2) {
                        // Pre-opening spend (always accelerated)
                        return spend + adSpendAccel[id];
                    }
                    return spend;
                }, 0);
            });

            // Display total rent for final month
            const finalIdx = getFinalMonthIndex();
            const activeRents = STUDIO_IDS.reduce((sum, id) => 
                sum + (projectionData[id][finalIdx].members > 0 ? rents[id] : 0), 0
            );
            setHtml('total-rent-display', '$' + activeRents.toLocaleString());
            
            // Display total fixed costs (rent + other fixed + mgmt)
            const activeStudiosCount = STUDIO_IDS.filter(id => projectionData[id][finalIdx].members > 0).length;
            const totalFixed = activeRents + (activeStudiosCount * otherFixed) + totalMgmtCost;
            setHtml('total-fixed-display', '$' + totalFixed.toLocaleString());

            // Calculate variable costs per studio - separate labor and commission
            const laborCosts = months.map((_, i) => {
                let cost = 0;
                STUDIO_IDS.forEach(id => {
                    const members = projectionData[id][i].members;
                    if (members > 0) {
                        const sessionHours = members * sessionsPm * sessionLengthHrs;
                        const totalVspHours = sessionHours / utils[id];
                        const stretchPay = sessionHours * vspRates[id].stretch;
                        const idlePay = (totalVspHours - sessionHours) * vspRates[id].idle;
                        cost += stretchPay + idlePay;
                    }
                });
                return cost;
            });
            
            const commissionCosts = months.map((_, i) => {
                return projectionData.total[i] * arpm * vspCommission;
            });
            
            // Combined for calculations
            const varCosts = laborCosts.map((l, i) => l + commissionCosts[i]);

            // Calculate contribution margin using weighted average utilization
            const avgUtil = STUDIO_IDS.reduce((sum, id) => sum + utils[id], 0) / STUDIO_IDS.length;
            
            // Average VSP rates across studios
            const avgStretch = STUDIO_IDS.reduce((sum, id) => sum + vspRates[id].stretch, 0) / STUDIO_IDS.length;
            const avgIdle = STUDIO_IDS.reduce((sum, id) => sum + vspRates[id].idle, 0) / STUDIO_IDS.length;
            
            // Cost per member per month considering utilization + commission
            const sessionHoursPerMember = sessionsPm * sessionLengthHrs;
            const totalVspHoursPerMember = sessionHoursPerMember / avgUtil;
            const laborCostPerMember = (sessionHoursPerMember * avgStretch) + ((totalVspHoursPerMember - sessionHoursPerMember) * avgIdle);
            const commissionPerMember = arpm * vspCommission;
            const totalLaborCostPerMember = laborCostPerMember + commissionPerMember;
            
            // Contribution margin needs to account for fees on revenue and commission
            const netArpm = arpm * (1 - totalFeePct);
            const contrib = netArpm - totalLaborCostPerMember;
            
            // Average fixed cost per studio (rent + other + ad spend) + management overhead spread across studios
            const avgRent = STUDIO_IDS.reduce((sum, id) => sum + rents[id], 0) / STUDIO_IDS.length;
            const avgAdSpendCalc = STUDIO_IDS.reduce((sum, id) => sum + adSpend[id], 0) / STUDIO_IDS.length;
            const avgFixed = avgRent + otherFixed + avgAdSpendCalc + (totalMgmtCost / STUDIO_IDS.length);
            const breakEven = Math.ceil(avgFixed / contrib);
            
            // Break-even revenue per studio
            const breakEvenRevenue = breakEven * arpm;
            
            // Safety margin: final month members vs break-even
            const finalMembers = projectionData.total[getFinalMonthIndex()];
            const avgMembersPerStudio = finalMembers / STUDIO_IDS.length;
            const safetyMarginPct = Math.round((avgMembersPerStudio / breakEven) * 100);

            setHtml('break-even-members', breakEven);
            setHtml('break-even-revenue', formatCurrency(breakEvenRevenue));
            setHtml('contribution-margin', '$' + Math.round(contrib));
            setHtml('avg-fixed-cost', formatCurrency(avgFixed));
            setHtml('safety-margin', safetyMarginPct + '%');
            
            // Color code safety margin
            const safetyBox = document.getElementById('safety-margin-box');
            if (safetyBox) {
                if (safetyMarginPct >= 120) {
                    safetyBox.className = 'stat-box success mb-1';
                } else if (safetyMarginPct >= 100) {
                    safetyBox.className = 'stat-box warning mb-1';
                } else {
                    safetyBox.className = 'stat-box danger mb-1';
                }
            }
            
            setHtml('bench-arpm', '$' + Math.round(arpm));
            
            // Update staff cost per member
            updateStaffCostPerMember(laborCosts, projectionData.total);
            
            // Update ARPM badge
            const arpmBadge = document.getElementById('bench-arpm-badge');
            if (arpmBadge) {
                if (arpm >= 195) {
                    arpmBadge.textContent = 'Excellent';
                    arpmBadge.className = 'badge mt-1 success';
                } else if (arpm >= 172) {
                    arpmBadge.textContent = 'Good';
                    arpmBadge.className = 'badge mt-1 success';
                } else if (arpm >= 130) {
                    arpmBadge.textContent = 'Average';
                    arpmBadge.className = 'badge mt-1 warning';
                } else {
                    arpmBadge.textContent = 'Low';
                    arpmBadge.className = 'badge mt-1 danger';
                }
            }

            // Determine active studios per month
            const activeStudios = months.map((_, i) => 
                STUDIO_IDS.filter(id => projectionData[id][i].members > 0).length
            );

            // Finance table - revenue based on calculated ARPM
            const grossRevenue = projectionData.total.map(t => t * arpm);
            const feesCosts = grossRevenue.map(r => r * totalFeePct);
            const netRevenue = grossRevenue.map((r, i) => r - feesCosts[i]);
            const studioFixed = months.map((_, i) => totalRent[i] + (activeStudios[i] * otherFixed));
            const mgmtCosts = Array(months.length).fill(totalMgmtCost);
            const fixedTotal = studioFixed.map((sf, i) => sf + mgmtCosts[i] + totalAdSpend[i]);
            const profit = netRevenue.map((r, i) => r - varCosts[i] - fixedTotal[i]);

            const rows = [
                { label: 'Total Members', data: projectionData.total },
                { label: 'Gross Revenue', data: grossRevenue, format: 'currency' },
                { label: 'Fees (Royalty/Brand/CC/Momence)', data: feesCosts, format: 'currency', style: 'color: #856404' },
                { label: 'Net Revenue', data: netRevenue, format: 'currency', style: 'font-weight: 600' },
                { label: 'VSP Labor (Hourly)', data: laborCosts, format: 'currency' },
                { label: 'VSP Commission (' + Math.round(vspCommission * 100) + '%)', data: commissionCosts, format: 'currency' },
                { label: 'Rent (NNN)', data: totalRent, format: 'currency' },
                { label: 'Other Studio Fixed', data: activeStudios.map(s => s * otherFixed), format: 'currency' },
                { label: 'Ad Spend', data: totalAdSpend, format: 'currency' },
                { label: 'GM + Owners', data: mgmtCosts, format: 'currency' },
                { label: 'Net Profit', data: profit, format: 'currency', highlight: true }
            ];

            const tableHtml = rows.map(row => {
                const cls = row.highlight ? 'total-row' : '';
                const cells = row.data.map(v => {
                    const val = row.format === 'currency' ? formatCurrency(v) : v;
                    const cellStyle = row.style ? row.style : (row.highlight && v < 0 ? 'color: #dc3545' : row.highlight && v > 0 ? 'color: #28a745' : '');
                    return `<td style="${cellStyle}">${val}</td>`;
                });
                return `<tr class="${cls}"><td>${row.label}</td>${cells.join('')}</tr>`;
            }).join('');
            setHtml('financeTableBody', tableHtml);

            // P&L Chart
            if (charts.pl) charts.pl.destroy();
            const ctx = document.getElementById('plChart')?.getContext('2d');
            if (ctx) {
                charts.pl = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [
                            { label: 'Gross Revenue', data: grossRevenue, borderColor: '#28a745', tension: 0.4, fill: false },
                            { label: 'Net Revenue (after fees)', data: netRevenue, borderColor: '#71BED2', tension: 0.4, fill: false, borderDash: [5,5] },
                            { label: 'Total Costs', data: varCosts.map((v, i) => v + fixedTotal[i]), borderColor: '#dc3545', tension: 0.4, fill: false },
                            { label: 'Profit', data: profit, borderColor: '#013160', borderWidth: 3, tension: 0.4, fill: false }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                });
            }
            
            // Cash Runway Calculation
            const startingCash = getVal('starting-cash', DEFAULTS.cash.startingCash);
            const cumulativeCash = [];
            let runningCash = startingCash;
            profit.forEach((p, i) => {
                runningCash += p;
                cumulativeCash.push(runningCash);
            });
            
            // Find lowest point and break-even month
            const lowestCash = Math.min(...cumulativeCash);
            const lowestIdx = cumulativeCash.indexOf(lowestCash);
            const totalCashNeeded = startingCash - lowestCash;
            
            // Find first month where cumulative cash is positive and stays positive (or profit is positive)
            let breakEvenIdx = -1;
            for (let i = 0; i < profit.length; i++) {
                if (profit[i] >= 0) {
                    breakEvenIdx = i;
                    break;
                }
            }
            
            // Update cash runway KPIs
            setHtml('cash-lowest', formatCurrency(lowestCash));
            document.getElementById('cash-lowest').style.color = lowestCash < 0 ? 'var(--danger)' : 'var(--success)';
            
            setHtml('cash-needed', totalCashNeeded > 0 ? formatCurrency(totalCashNeeded) : '$0');
            
            const breakEvenMonth = breakEvenIdx >= 0 ? months[breakEvenIdx] : 'Not in range';
            setHtml('cash-break-even-month', breakEvenMonth);
            document.getElementById('cash-break-even-month').style.color = breakEvenIdx >= 0 ? 'var(--success)' : 'var(--danger)';
            
            // Cash Runway Chart
            if (charts.cashRunway) charts.cashRunway.destroy();
            const cashCtx = document.getElementById('cashRunwayChart')?.getContext('2d');
            if (cashCtx) {
                charts.cashRunway = new Chart(cashCtx, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [
                            { 
                                label: 'Cash Position', 
                                data: cumulativeCash, 
                                borderColor: '#013160',
                                backgroundColor: cumulativeCash.map(c => c >= 0 ? 'rgba(40, 167, 69, 0.2)' : 'rgba(220, 53, 69, 0.2)'),
                                fill: true,
                                tension: 0.4
                            },
                            {
                                label: 'Break-Even Line',
                                data: Array(months.length).fill(0),
                                borderColor: '#6c757d',
                                borderDash: [5, 5],
                                borderWidth: 1,
                                pointRadius: 0,
                                fill: false
                            }
                        ]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { 
                                ticks: { callback: v => '$' + (v/1000).toFixed(0) + 'K' }
                            }
                        }
                    }
                });
            }

            // ==========================================
            // BREAK-EVEN TIMELINE BY STUDIO
            // ==========================================
            // Calculate per-studio P&L and break-even months
            const studioBreakEvenData = {};
            const mgmtAllocationPerStudio = totalMgmtCost / Math.max(1, Math.max(...activeStudios));
            
            STUDIO_IDS.forEach(id => {
                const def = DEFAULTS.studios[id];
                const name = STUDIO_NAMES[id];
                const data = projectionData[id];
                const rent = projectionData.rents[id];
                const studioAdSpend = projectionData.adSpend[id];
                const studioAdSpendAccel = projectionData.adSpendAccel?.[id] || studioAdSpend;
                const isNewStudio = def.opens !== undefined;
                const opensMonth = isNewStudio ? getVal(`${id}-opens`, def.opens) : 0;
                
                // Calculate per-studio P&L for each month
                const studioProfit = data.map((d, i) => {
                    if (d.members === 0) return null; // Studio not open
                    
                    const members = d.members;
                    const grossRev = members * arpm;
                    const fees = grossRev * totalFeePct;
                    const netRev = grossRev - fees;
                    
                    // Labor costs (proportional to members)
                    const studioLabor = laborCosts[i] * (members / (projectionData.total[i] || 1));
                    const studioCommission = commissionCosts[i] * (members / (projectionData.total[i] || 1));
                    
                    // Fixed costs for this studio
                    const studioFixedCosts = rent + otherFixed + mgmtAllocationPerStudio;
                    
                    // Ad spend (use accelerated during launch period)
                    const currentMonthNum = d.monthNum || 0;
                    let isAccelPeriod = false;
                    if (isNewStudio) {
                        isAccelPeriod = currentMonthNum >= 1 && currentMonthNum <= 3;
                    } else {
                        isAccelPeriod = currentMonthNum >= 1 && currentMonthNum <= 3;
                    }
                    const monthAdSpend = isAccelPeriod ? studioAdSpendAccel : studioAdSpend;
                    
                    return netRev - studioLabor - studioCommission - studioFixedCosts - monthAdSpend;
                });
                
                // Find first profitable month
                let breakEvenMonth = -1;
                for (let i = 0; i < studioProfit.length; i++) {
                    if (studioProfit[i] !== null && studioProfit[i] >= 0) {
                        breakEvenMonth = i;
                        break;
                    }
                }
                
                // Calculate months until profitable (from when studio opens)
                let monthsToProfit = null;
                if (breakEvenMonth >= 0) {
                    if (isNewStudio) {
                        monthsToProfit = breakEvenMonth - (opensMonth - 1);
                    } else {
                        monthsToProfit = breakEvenMonth; // Existing studio, count from start
                    }
                }
                
                studioBreakEvenData[id] = {
                    name,
                    profit: studioProfit,
                    breakEvenIdx: breakEvenMonth,
                    breakEvenMonth: breakEvenMonth >= 0 ? months[breakEvenMonth] : 'Not in range',
                    monthsToProfit,
                    lastProfit: studioProfit.filter(p => p !== null).slice(-1)[0] || 0
                };
            });
            
            // Generate break-even cards
            const breakEvenCardsHtml = STUDIO_IDS.map(id => {
                const data = studioBreakEvenData[id];
                const def = DEFAULTS.studios[id];
                const isNewStudio = def.opens !== undefined;
                
                let statusClass = 'danger';
                let statusText = 'Not Profitable';
                if (data.breakEvenIdx >= 0) {
                    if (data.monthsToProfit <= 3) {
                        statusClass = 'success';
                        statusText = 'Fast Break-Even';
                    } else if (data.monthsToProfit <= 6) {
                        statusClass = 'warning';
                        statusText = 'On Track';
                    } else {
                        statusClass = 'info';
                        statusText = 'Slow Ramp';
                    }
                }
                
                return `
                    <div class="stat-box ${statusClass}">
                        <div class="label" style="font-weight: 600; margin-bottom: 0.25rem;">${data.name}</div>
                        <div class="value" style="font-size: 1.1rem;">${data.breakEvenMonth}</div>
                        <div class="label">${data.monthsToProfit !== null ? `Month ${data.monthsToProfit} after ${isNewStudio ? 'opening' : 'start'}` : 'Not reached'}</div>
                        <div style="margin-top: 0.25rem; font-size: 0.75rem;">
                            Dec '26: <span style="color: ${data.lastProfit >= 0 ? 'var(--success)' : 'var(--danger)'};">${formatCurrency(data.lastProfit)}</span>
                        </div>
                        <span class="badge ${statusClass}" style="margin-top: 0.25rem;">${statusText}</span>
                    </div>
                `;
            }).join('');
            setHtml('studioBreakEvenCards', breakEvenCardsHtml);
            
            // Break-Even Timeline Chart
            if (charts.breakEvenTimeline) charts.breakEvenTimeline.destroy();
            const beTimelineCtx = document.getElementById('breakEvenTimelineChart')?.getContext('2d');
            if (beTimelineCtx) {
                const datasets = STUDIO_IDS.map(id => {
                    const data = studioBreakEvenData[id];
                    return {
                        label: data.name,
                        data: data.profit.map(p => p === null ? NaN : p),
                        borderColor: STUDIO_COLORS[id],
                        backgroundColor: STUDIO_COLORS[id] + '33',
                        tension: 0.4,
                        fill: false,
                        spanGaps: false
                    };
                });
                
                // Add break-even line
                datasets.push({
                    label: 'Break-Even',
                    data: Array(months.length).fill(0),
                    borderColor: '#6c757d',
                    borderDash: [5, 5],
                    borderWidth: 2,
                    pointRadius: 0,
                    fill: false
                });
                
                charts.breakEvenTimeline = new Chart(beTimelineCtx, {
                    type: 'line',
                    data: { labels: months, datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { position: 'bottom' },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        if (isNaN(context.raw)) return context.dataset.label + ': Not open';
                                        return context.dataset.label + ': ' + formatCurrency(context.raw);
                                    }
                                }
                            }
                        },
                        scales: {
                            y: { 
                                ticks: { callback: v => '$' + (v/1000).toFixed(0) + 'K' }
                            }
                        }
                    }
                });
            }
        }

        function updateOperations() {
            const sessionLen = getVal('session-length-fin', DEFAULTS.costs.sessionLength);
            const sessionsPm = getVal('sessions-pm', DEFAULTS.costs.sessionsPm);
            
            // Get per-studio VSP rates
            const vspRates = Object.fromEntries(
                STUDIO_IDS.map(id => [id, {
                    stretch: getVal(`${id}-vsp-stretch`, DEFAULTS.studios[id].vspStretch),
                    idle: getVal(`${id}-vsp-idle`, DEFAULTS.studios[id].vspIdle)
                }])
            );

            const utils = projectionData.util || Object.fromEntries(
                STUDIO_IDS.map(id => [id, DEFAULTS.studios[id].util / 100])
            );
            const capacity = projectionData.capacity || Object.fromEntries(
                STUDIO_IDS.map(id => [id, { 
                    tables: DEFAULTS.studios[id].tables, 
                    hours: DEFAULTS.studios[id].hours, 
                    days: DEFAULTS.studios[id].days 
                }])
            );

            // Update utilization displays in operations
            STUDIO_IDS.forEach(id => {
                setHtml(`ops-${id}-util`, Math.round(utils[id] * 100) + '%');
            });

            const sessionsPerHour = 60 / sessionLen;
            
            // Calculate per-studio capacity and members per VSP (FTE)
            const maxMembersPerStudio = {};
            const membersPerVspPerStudio = {};
            const maxSessionsPerStudio = {};
            
            STUDIO_IDS.forEach(id => {
                const cap = capacity[id];
                const maxSessionsWeek = cap.tables * cap.hours * cap.days * sessionsPerHour;
                const maxSessionsMonth = maxSessionsWeek * 4.33;
                maxSessionsPerStudio[id] = maxSessionsWeek;
                
                // Max members based on utilization and sessions per member
                maxMembersPerStudio[id] = Math.floor((maxSessionsMonth * utils[id]) / sessionsPm);
                
                // Calculate members per VSP (FTE) based on hours worked
                // FTE VSP works ~40 hrs/week, can do sessionsPerHour stretches
                // At studio utilization%, they're stretching util% of the time
                const fteHoursPerWeek = 40;
                const fteSessionsPerWeek = fteHoursPerWeek * sessionsPerHour * utils[id];
                const fteSessionsPerMonth = fteSessionsPerWeek * 4.33;
                membersPerVspPerStudio[id] = Math.floor(fteSessionsPerMonth / sessionsPm);
            });

            // Average blended rate across studios (using per-studio rates)
            const avgUtil = STUDIO_IDS.reduce((sum, id) => sum + utils[id], 0) / STUDIO_IDS.length;
            const avgStretch = STUDIO_IDS.reduce((sum, id) => sum + vspRates[id].stretch, 0) / STUDIO_IDS.length;
            const avgIdle = STUDIO_IDS.reduce((sum, id) => sum + vspRates[id].idle, 0) / STUDIO_IDS.length;
            const avgBlended = (avgStretch * avgUtil) + (avgIdle * (1 - avgUtil));
            setHtml('avg-blended-rate', '$' + avgBlended.toFixed(2));

            // Total capacity and headroom based on per-studio utilization
            let totalCapacity = 0;
            STUDIO_IDS.forEach(id => {
                if (projectionData[id][getFinalMonthIndex()].members > 0) {
                    totalCapacity += maxMembersPerStudio[id];
                }
            });
            
            const headroom = totalCapacity - projectionData.total[getFinalMonthIndex()];

            setHtml('total-capacity', totalCapacity);
            setHtml('headroom', (headroom >= 0 ? '+' : '') + headroom);

            // Staffing table with FTE/PT breakdown
            
            // Calculate staffing per studio per month: FTE (max per CONFIG) + PT
            const staffingData = {};
            STUDIO_IDS.forEach(id => {
                staffingData[id] = projectionData[id].map(d => {
                    if (d.members <= 0) return { fte: 0, pt: 0, total: 0 };
                    const membersPerFte = membersPerVspPerStudio[id];
                    const totalVspsNeeded = d.members / membersPerFte;
                    const fte = Math.min(CONFIG.staffing.maxFtePerStudio, Math.floor(totalVspsNeeded));
                    const remainingMembers = d.members - (fte * membersPerFte);
                    // PT workers handle ~20 hrs/week (half of FTE)
                    const ptMembersPerWorker = membersPerFte / 2;
                    const pt = remainingMembers > 0 ? Math.ceil(remainingMembers / ptMembersPerWorker) : 0;
                    return { fte, pt, total: fte + pt };
                });
            });

            // Build staffing rows with FTE/PT notation
            const staffingRows = STUDIO_IDS.map(id => {
                const data = staffingData[id];
                const cells = data.map(d => {
                    if (d.total === 0) return '-';
                    if (d.pt === 0) return `${d.fte} FTE`;
                    return `${d.fte}F + ${d.pt}P`;
                });
                return `<tr><td>${STUDIO_NAMES[id]}</td>${cells.map(c => `<td>${c}</td>`).join('')}</tr>`;
            });

            // Add a row showing calculated members per VSP (FTE) per studio
            const membersPerVspRow = `<tr style="background: #e8f5e9; font-size: 0.8rem;"><td>Members/FTE</td>${
                STUDIO_IDS.map(id => 
                    `<td colspan="3" style="text-align: center;">${STUDIO_NAMES[id].split(' ')[0]}: ${membersPerVspPerStudio[id]}</td>`
                ).join('')
            }<td></td></tr>`;

            // Total VSPs row
            const totalVsps = months.map((_, i) => 
                STUDIO_IDS.reduce((sum, id) => sum + staffingData[id][i].total, 0)
            );
            
            const totalFte = months.map((_, i) => 
                STUDIO_IDS.reduce((sum, id) => sum + staffingData[id][i].fte, 0)
            );
            
            const totalPt = months.map((_, i) => 
                STUDIO_IDS.reduce((sum, id) => sum + staffingData[id][i].pt, 0)
            );
            
            staffingRows.push(`<tr class="total-row"><td>TOTAL FTE</td>${totalFte.map(v => `<td>${v}</td>`).join('')}</tr>`);
            staffingRows.push(`<tr class="total-row"><td>TOTAL PT</td>${totalPt.map(v => `<td>${v}</td>`).join('')}</tr>`);
            staffingRows.push(`<tr class="total-row" style="background: #013160; color: white;"><td>TOTAL STAFF</td>${totalVsps.map(v => `<td>${v}</td>`).join('')}</tr>`);
            
            setHtml('staffingTableBody', staffingRows.join(''));
            
            // Staffing Comparison: Initial Setup vs Current Month Requirements
            const comparisonHtml = STUDIO_IDS.map(id => {
                const def = DEFAULTS.studios[id];
                const isNewStudio = def.opens !== undefined;
                const opensMonth = isNewStudio ? getVal(`${id}-opens`, def.opens) : 0;
                
                // Get current month's required staffing (index 0 = Dec-25)
                const currentRequired = staffingData[id][0];
                const initialSetup = def.initialStaff;
                
                // Calculate total hours using CONFIG values
                const initialHours = (initialSetup.fte * CONFIG.staffing.fteHoursPerWeek) + (initialSetup.pt * CONFIG.staffing.ptHoursPerWeek);
                const requiredHours = (currentRequired.fte * CONFIG.staffing.fteHoursPerWeek) + (currentRequired.pt * CONFIG.staffing.ptHoursPerWeek);
                
                // Check if studio is active
                const isActive = projectionData[id][0].members > 0;
                
                // Calculate staffing ratio (initial / required)
                const staffingRatio = requiredHours > 0 ? initialHours / requiredHours : 0;
                
                // Determine status with overstaffing levels
                let status, statusColor, statusIcon;
                if (!isActive) {
                    status = 'Not Open';
                    statusColor = 'var(--muted)';
                    statusIcon = '‚è≥';
                } else if (staffingRatio >= CONFIG.staffing.overstaffHighThreshold) {
                    // Highly overstaffed - significant excess labor cost
                    status = 'Overstaffed (High)';
                    statusColor = '#9c27b0'; // Purple for over
                    statusIcon = 'üìà';
                } else if (staffingRatio >= CONFIG.staffing.overstaffThreshold) {
                    // Moderately overstaffed
                    status = 'Overstaffed';
                    statusColor = '#ff9800'; // Orange
                    statusIcon = 'üìä';
                } else if (staffingRatio >= 1.0) {
                    // Adequate with buffer
                    status = 'Adequate';
                    statusColor = 'var(--success)';
                    statusIcon = '‚úÖ';
                } else if (staffingRatio >= CONFIG.staffing.tightThreshold) {
                    // Tight but manageable
                    status = 'Tight';
                    statusColor = 'var(--warning)';
                    statusIcon = '‚ö†Ô∏è';
                } else {
                    // Below 80% - understaffed
                    status = 'Understaffed';
                    statusColor = 'var(--danger)';
                    statusIcon = '‚ùå';
                }
                
                const diff = initialHours - requiredHours;
                const diffText = diff >= 0 ? `+${diff} hrs/wk` : `${diff} hrs/wk`;
                const pctText = requiredHours > 0 ? ` (${Math.round((staffingRatio - 1) * 100)}%)` : '';
                
                return `
                    <div class="stat-box" style="border-left: 4px solid ${STUDIO_COLORS[id]}; padding: 0.75rem;">
                        <div style="font-weight: 600; margin-bottom: 0.5rem;">${STUDIO_NAMES[id]} ${statusIcon}</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.85rem;">
                            <div>
                                <div style="color: var(--muted); font-size: 0.75rem;">Initial Setup</div>
                                <div>${initialSetup.fte}F + ${initialSetup.pt}P <span style="color: var(--muted);">(${initialHours} hrs)</span></div>
                            </div>
                            <div>
                                <div style="color: var(--muted); font-size: 0.75rem;">Required Now</div>
                                <div>${isActive ? `${currentRequired.fte}F + ${currentRequired.pt}P <span style="color: var(--muted);">(${requiredHours} hrs)</span>` : '-'}</div>
                            </div>
                        </div>
                        <div style="margin-top: 0.5rem; font-weight: 600; color: ${statusColor};">
                            ${status} ${isActive ? `<span style="font-weight: 400;">(${diffText}${pctText})</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            setHtml('staffingComparison', comparisonHtml);

            // Store for use elsewhere
            projectionData.membersPerVsp = membersPerVspPerStudio;
            projectionData.staffing = staffingData;

            // Utilization chart - show actual per-studio utilization vs capacity
            const utilizationData = months.map((_, i) => {
                let totalUsed = 0;
                let totalCap = 0;
                STUDIO_IDS.forEach(id => {
                    if (projectionData[id][i].members > 0) {
                        totalUsed += projectionData[id][i].members;
                        totalCap += maxMembersPerStudio[id];
                    }
                });
                return totalCap > 0 ? (totalUsed / totalCap) * 100 : 0;
            });

            if (charts.utilization) charts.utilization.destroy();
            const ctx = document.getElementById('utilizationChart')?.getContext('2d');
            if (ctx) {
                charts.utilization = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [
                            { label: 'Portfolio Utilization %', data: utilizationData, borderColor: '#71BED2', tension: 0.4, fill: true, backgroundColor: 'rgba(113,190,210,0.2)' }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { max: 100 } } }
                });
            }

            // Hiring alerts - now in table format
            // Hire ONE MONTH BEFORE utilization exceeds threshold
            const UTIL_THRESHOLD = CONFIG.staffing.utilThreshold;
            let hiringRows = [];
            const currentStaff = Object.fromEntries(
                STUDIO_IDS.map(id => [id, { ...DEFAULTS.studios[id].initialStaff }])
            );
            // Track members at last hire for delta calculation (start with month 0 members)
            const lastHireMembers = Object.fromEntries(STUDIO_IDS.map(id => [id, projectionData[id][0].members]));
            
            STUDIO_IDS.forEach(id => {
                const projData = projectionData[id];
                
                for (let i = 0; i < projData.length; i++) {
                    // Look at NEXT month's utilization to decide if we hire THIS month
                    const nextMonthIdx = i + 1;
                    if (nextMonthIdx >= projData.length) continue;
                    
                    const nextMonthMembers = projData[nextMonthIdx].members;
                    const nextMonthSessions = nextMonthMembers * sessionsPm;
                    const revenueHours = nextMonthSessions; // 1 session = 1 hour of revenue
                    
                    // Current staff hours worked
                    const currentFteHours = currentStaff[id].fte * 40 * 4.33;
                    const currentPtHours = currentStaff[id].pt * 20 * 4.33;
                    const currentHoursWorked = currentFteHours + currentPtHours;
                    
                    // Utilization = Revenue Hours / Hours Worked
                    const nextMonthUtil = currentHoursWorked > 0 ? revenueHours / currentHoursWorked : 999;
                    
                    // If next month exceeds threshold, hire this month
                    if (nextMonthUtil > UTIL_THRESHOLD) {
                        // Determine how much staff we need to get under threshold
                        const hoursNeededForTarget = revenueHours / UTIL_THRESHOLD;
                        const weeklyHoursNeeded = hoursNeededForTarget / 4.33;
                        
                        // Calculate new staffing - prefer PT for flexibility, max 2 FTE
                        let newFte = currentStaff[id].fte;
                        let newPt = currentStaff[id].pt;
                        
                        // First try adding PT (more flexible, less commitment)
                        while ((newFte * CONFIG.staffing.fteHoursPerWeek + newPt * CONFIG.staffing.ptHoursPerWeek) < weeklyHoursNeeded && newPt < CONFIG.staffing.maxPtPerStudio) {
                            newPt++;
                        }
                        // If still not enough, add FTE (max per studio from CONFIG)
                        while ((newFte * CONFIG.staffing.fteHoursPerWeek + newPt * CONFIG.staffing.ptHoursPerWeek) < weeklyHoursNeeded && newFte < CONFIG.staffing.maxFtePerStudio) {
                            newFte++;
                        }
                        
                        const neededFte = newFte - currentStaff[id].fte;
                        const neededPt = newPt - currentStaff[id].pt;
                        
                        if (neededFte > 0 || neededPt > 0) {
                            // After hire capacity (hours worked)
                            const newFteHours = newFte * 40 * 4.33;
                            const newPtHours = newPt * 20 * 4.33;
                            const newHoursWorked = newFteHours + newPtHours;
                            const utilAfter = Math.round((revenueHours / newHoursWorked) * 100);
                            
                            // Member growth since last hire
                            const memberDelta = nextMonthMembers - lastHireMembers[id];
                            
                            hiringRows.push({
                                studio: STUDIO_NAMES[id],
                                hireMonth: months[i],        // When to hire
                                needMonth: months[nextMonthIdx], // When capacity is needed
                                monthIdx: i,
                                fte: neededFte > 0 ? `+${neededFte}` : '-',
                                pt: neededPt > 0 ? `+${neededPt}` : '-',
                                members: nextMonthMembers,
                                memberDelta: memberDelta,
                                utilBefore: Math.min(999, Math.round(nextMonthUtil * 100)),
                                utilAfter: utilAfter
                            });
                            
                            // Update current staff after hire
                            currentStaff[id].fte = newFte;
                            currentStaff[id].pt = newPt;
                            lastHireMembers[id] = nextMonthMembers;
                        }
                    }
                }
            });
            
            // Sort by month
            hiringRows.sort((a, b) => a.monthIdx - b.monthIdx);
            
            let hiringHtml = '';
            if (hiringRows.length > 0) {
                hiringHtml = `
                    <p style="font-size: 0.8rem; color: var(--muted); margin-bottom: 0.75rem;">
                        <strong>Trigger:</strong> Hire when next month's utilization (revenue hrs √∑ worked hrs) exceeds 75%
                    </p>
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                        <thead>
                            <tr style="background: var(--gray); text-align: left;">
                                <th style="padding: 0.5rem 0.75rem; border-bottom: 2px solid var(--border);">Hire By</th>
                                <th style="padding: 0.5rem 0.75rem; border-bottom: 2px solid var(--border);">Needed For</th>
                                <th style="padding: 0.5rem 0.75rem; border-bottom: 2px solid var(--border);">Studio</th>
                                <th style="padding: 0.5rem 0.75rem; border-bottom: 2px solid var(--border); text-align: center;">FTE</th>
                                <th style="padding: 0.5rem 0.75rem; border-bottom: 2px solid var(--border); text-align: center;">PT</th>
                                <th style="padding: 0.5rem 0.75rem; border-bottom: 2px solid var(--border); text-align: right;">Members</th>
                                <th style="padding: 0.5rem 0.75rem; border-bottom: 2px solid var(--border); text-align: right;">+Added</th>
                                <th style="padding: 0.5rem 0.75rem; border-bottom: 2px solid var(--border); text-align: center;">Util Before</th>
                                <th style="padding: 0.5rem 0.75rem; border-bottom: 2px solid var(--border); text-align: center;">Util After</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${hiringRows.map(row => `
                                <tr style="border-bottom: 1px solid var(--border);">
                                    <td style="padding: 0.5rem 0.75rem; font-weight: 600; color: var(--primary);">${row.hireMonth}</td>
                                    <td style="padding: 0.5rem 0.75rem;">${row.needMonth}</td>
                                    <td style="padding: 0.5rem 0.75rem;">${row.studio}</td>
                                    <td style="padding: 0.5rem 0.75rem; text-align: center; color: ${row.fte !== '-' ? 'var(--success)' : 'var(--muted)'}; font-weight: ${row.fte !== '-' ? '600' : '400'};">${row.fte}</td>
                                    <td style="padding: 0.5rem 0.75rem; text-align: center; color: ${row.pt !== '-' ? 'var(--success)' : 'var(--muted)'}; font-weight: ${row.pt !== '-' ? '600' : '400'};">${row.pt}</td>
                                    <td style="padding: 0.5rem 0.75rem; text-align: right;">${row.members}</td>
                                    <td style="padding: 0.5rem 0.75rem; text-align: right; color: var(--success); font-weight: 500;">+${row.memberDelta}</td>
                                    <td style="padding: 0.5rem 0.75rem; text-align: center; color: ${row.utilBefore > 85 ? 'var(--danger)' : row.utilBefore > 75 ? '#856404' : 'inherit'}; font-weight: ${row.utilBefore > 75 ? '600' : '400'};">${row.utilBefore > 200 ? '>200' : row.utilBefore}%</td>
                                    <td style="padding: 0.5rem 0.75rem; text-align: center; color: var(--success); font-weight: 500;">${row.utilAfter}%</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }
            setHtml('hiringAlerts', hiringHtml || '<div class="text-muted">No immediate hiring needs</div>');

            // ==========================================
            // STAFFING COST ANALYSIS
            // ==========================================
            const revPerHour = getVal('rev-per-hour', DEFAULTS.revenue.revPerHour);
            
            // Calculate labor costs and metrics for final month
            const finalIdx = getFinalMonthIndex();
            let totalPortfolioLaborCost = 0;
            let totalPortfolioRevenue = 0;
            let totalStaffHours = 0;
            
            const laborMetrics = STUDIO_IDS.map(id => {
                const members = projectionData[id][finalIdx].members;
                const monthlyRevenue = projectionData[id][finalIdx].revenue || (members * calcArpm());
                
                if (members <= 0) {
                    return { id, name: STUDIO_NAMES[id], members, active: false };
                }
                
                // Get staffing for this studio in final month
                const staff = staffingData[id][finalIdx];
                const fteHours = staff.fte * CONFIG.staffing.fteHoursPerWeek * 4.33;
                const ptHours = staff.pt * CONFIG.staffing.ptHoursPerWeek * 4.33;
                const totalHours = fteHours + ptHours;
                
                // Calculate labor cost using blended rate based on studio utilization and per-studio rates
                const studioUtil = utils[id];
                const studioStretch = getVal(`${id}-vsp-stretch`, DEFAULTS.studios[id].vspStretch);
                const studioIdle = getVal(`${id}-vsp-idle`, DEFAULTS.studios[id].vspIdle);
                const blendedRate = (studioStretch * studioUtil) + (studioIdle * (1 - studioUtil));
                const monthlyLaborCost = totalHours * blendedRate;
                
                // Revenue per staff hour
                const revPerStaffHour = totalHours > 0 ? monthlyRevenue / totalHours : 0;
                
                // Labor as % of revenue
                const laborPctRevenue = monthlyRevenue > 0 ? (monthlyLaborCost / monthlyRevenue) * 100 : 0;
                
                // Members per FTE equivalent
                const fteEquiv = staff.fte + (staff.pt * 0.5);
                const membersPerFte = fteEquiv > 0 ? members / fteEquiv : 0;
                
                // Break-even utilization: at what util does labor cost equal gross margin?
                // Gross margin = revenue - variable costs (fees)
                const totalFeePct = (getVal('royaltyFee', DEFAULTS.fees.royalty) + getVal('brandFee', DEFAULTS.fees.brand) + 
                                    getVal('ccFee', DEFAULTS.fees.cc) + getVal('momenceFee', DEFAULTS.fees.momence)) / 100;
                const grossMarginPct = 1 - totalFeePct;
                // Break-even: laborCost = grossMargin √ó revenue
                // At break-even: hours √ó blendedRate(BE_util) = grossMarginPct √ó revenue
                // Simplify: break-even util where labor ~= 25-35% of revenue is sustainable
                const breakEvenUtil = monthlyRevenue > 0 ? Math.min(100, Math.max(0, 
                    ((monthlyLaborCost / grossMarginPct) / monthlyRevenue) * 100)) : 0;
                
                totalPortfolioLaborCost += monthlyLaborCost;
                totalPortfolioRevenue += monthlyRevenue;
                totalStaffHours += totalHours;
                
                // Status based on labor % of revenue
                let status, statusColor;
                if (laborPctRevenue < 25) {
                    status = 'Excellent';
                    statusColor = 'var(--success)';
                } else if (laborPctRevenue < 35) {
                    status = 'Good';
                    statusColor = 'var(--warning)';
                } else {
                    status = 'Review';
                    statusColor = 'var(--danger)';
                }
                
                return {
                    id, 
                    name: STUDIO_NAMES[id],
                    members,
                    active: true,
                    monthlyLaborCost,
                    laborPctRevenue,
                    revPerStaffHour,
                    membersPerFte,
                    breakEvenUtil: studioUtil * 100, // Current util as proxy
                    status,
                    statusColor,
                    totalHours,
                    monthlyRevenue
                };
            });
            
            // Portfolio-level metrics
            const portfolioLaborPct = totalPortfolioRevenue > 0 ? (totalPortfolioLaborCost / totalPortfolioRevenue) * 100 : 0;
            const portfolioRevPerHour = totalStaffHours > 0 ? totalPortfolioRevenue / totalStaffHours : 0;
            const portfolioLaborPerMember = projectionData.total[finalIdx] > 0 ? totalPortfolioLaborCost / projectionData.total[finalIdx] : 0;
            
            // Update summary cards
            const cardHtml = `
                <div class="stat-box ${portfolioLaborPct < 25 ? 'success' : portfolioLaborPct < 35 ? 'warning' : 'danger'}">
                    <div class="value">${portfolioLaborPct.toFixed(1)}%</div>
                    <div class="label">Labor % of Revenue</div>
                </div>
                <div class="stat-box ${portfolioRevPerHour >= 80 ? 'success' : portfolioRevPerHour >= 60 ? 'warning' : 'danger'}">
                    <div class="value">$${portfolioRevPerHour.toFixed(0)}</div>
                    <div class="label">Revenue/Staff Hour</div>
                </div>
                <div class="stat-box info">
                    <div class="value">$${(totalPortfolioLaborCost/1000).toFixed(1)}K</div>
                    <div class="label">Total Monthly Labor</div>
                </div>
                <div class="stat-box">
                    <div class="value">$${portfolioLaborPerMember.toFixed(0)}</div>
                    <div class="label">Labor Cost/Member</div>
                </div>
            `;
            setHtml('staffingCostCards', cardHtml);
            
            // Update labor cost per member in capacity summary
            setHtml('staff-cost-per-member', '$' + portfolioLaborPerMember.toFixed(0));
            
            // Build labor cost table
            const laborRows = laborMetrics.filter(m => m.active).map(m => `
                <tr>
                    <td style="border-left: 3px solid ${STUDIO_COLORS[m.id]};">${m.name}</td>
                    <td style="text-align: right;">$${(m.monthlyLaborCost/1000).toFixed(1)}K</td>
                    <td style="text-align: center; color: ${m.statusColor}; font-weight: 600;">${m.laborPctRevenue.toFixed(1)}%</td>
                    <td style="text-align: center; color: ${m.revPerStaffHour >= 80 ? 'var(--success)' : m.revPerStaffHour >= 60 ? '#856404' : 'var(--danger)'};">$${m.revPerStaffHour.toFixed(0)}</td>
                    <td style="text-align: center;">${m.membersPerFte.toFixed(1)}</td>
                    <td style="text-align: center;">${m.breakEvenUtil.toFixed(0)}%</td>
                    <td style="text-align: center; color: ${m.statusColor}; font-weight: 600;">${m.status}</td>
                </tr>
            `).join('');
            
            // Add totals row
            const activeCount = laborMetrics.filter(m => m.active).length;
            const totalRow = `
                <tr class="total-row">
                    <td><strong>PORTFOLIO (${activeCount} studios)</strong></td>
                    <td style="text-align: right;"><strong>$${(totalPortfolioLaborCost/1000).toFixed(1)}K</strong></td>
                    <td style="text-align: center; font-weight: 600; color: ${portfolioLaborPct < 25 ? 'var(--success)' : portfolioLaborPct < 35 ? '#856404' : 'var(--danger)'};">${portfolioLaborPct.toFixed(1)}%</td>
                    <td style="text-align: center; font-weight: 600; color: ${portfolioRevPerHour >= 80 ? 'var(--success)' : portfolioRevPerHour >= 60 ? '#856404' : 'var(--danger)'};">$${portfolioRevPerHour.toFixed(0)}</td>
                    <td style="text-align: center;">-</td>
                    <td style="text-align: center;">-</td>
                    <td></td>
                </tr>
            `;
            
            setHtml('laborCostTableBody', laborRows + totalRow);
            
            // Labor efficiency trend (mini sparkline style)
            const efficiencyTrend = [0, 3, 6, 9, 12].map(i => {
                let totalRev = 0, totalLabor = 0;
                STUDIO_IDS.forEach(id => {
                    if (projectionData[id][i].members > 0) {
                        const staff = staffingData[id][i];
                        const hours = (staff.fte * CONFIG.staffing.fteHoursPerWeek + staff.pt * CONFIG.staffing.ptHoursPerWeek) * 4.33;
                        const studioStretch = getVal(`${id}-vsp-stretch`, DEFAULTS.studios[id].vspStretch);
                        const studioIdle = getVal(`${id}-vsp-idle`, DEFAULTS.studios[id].vspIdle);
                        const blended = (studioStretch * utils[id]) + (studioIdle * (1 - utils[id]));
                        totalLabor += hours * blended;
                        totalRev += projectionData[id][i].revenue || (projectionData[id][i].members * calcArpm());
                    }
                });
                return totalRev > 0 ? ((totalLabor / totalRev) * 100).toFixed(0) : '-';
            });
            
            const trendHtml = ['Dec-25', 'Mar-26', 'Jun-26', 'Sep-26', 'Dec-26'].map((m, i) => {
                const val = efficiencyTrend[i];
                const color = val === '-' ? 'var(--muted)' : val < 25 ? 'var(--success)' : val < 35 ? '#856404' : 'var(--danger)';
                return `<span style="padding: 0.25rem 0.5rem; background: var(--gray); border-radius: 4px; font-size: 0.75rem;">
                    ${m}: <strong style="color: ${color};">${val}%</strong>
                </span>`;
            }).join('');
            setHtml('labor-efficiency-trend', trendHtml);
        }

        // Helper to calculate all studios for a scenario
        function calculateScenario(ramp, maint, churn, seasonality) {
            const results = {};
            STUDIO_IDS.forEach(id => {
                const def = DEFAULTS.studios[id];
                const isNewStudio = def.opens !== undefined;
                const startMonth = isNewStudio ? 1 : getVal(`${id}-month`, def.month);
                const opensMonth = isNewStudio ? getVal(`${id}-opens`, def.opens) : 0;
                results[id] = calculateStudio(getVal(`${id}-current`, def.current), startMonth, ramp, maint, churn, seasonality, opensMonth);
            });
            results.total = STUDIO_IDS.reduce((sum, id) => sum + results[id][getFinalMonthIndex()].members, 0);
            results.targetsHit = STUDIO_IDS.filter(id => 
                findMonth9Value(results[id]) >= getVal(`${id}-target`, DEFAULTS.studios[id].target)
            ).length;
            return results;
        }

        function updateScenarios() {
            const seasonality = getSeasonality();
            const arpm = calcArpm();
            const endMonth = months[months.length - 1];
            
            // Get costs for net profit calculation
            const totalFeePct = (getVal('royaltyFee', DEFAULTS.fees.royalty) + getVal('brandFee', DEFAULTS.fees.brand) + 
                                getVal('ccFee', DEFAULTS.fees.cc) + getVal('momenceFee', DEFAULTS.fees.momence)) / 100;
            // Get averaged per-studio VSP rates
            const avgVspStretch = STUDIO_IDS.reduce((sum, id) => sum + getVal(`${id}-vsp-stretch`, DEFAULTS.studios[id].vspStretch), 0) / STUDIO_IDS.length;
            const avgVspIdle = STUDIO_IDS.reduce((sum, id) => sum + getVal(`${id}-vsp-idle`, DEFAULTS.studios[id].vspIdle), 0) / STUDIO_IDS.length;
            const vspCommission = getVal('vsp-commission', DEFAULTS.costs.vspCommission) / 100;
            const sessionsPm = getVal('sessions-pm', DEFAULTS.revenue.sessionsPm);
            const sessionLengthHrs = getVal('session-length-fin', DEFAULTS.revenue.sessionLength) / 60;
            const otherFixed = getVal('other-fixed-costs', DEFAULTS.costs.otherFixed);
            const gmSalary = getVal('gm-salary', DEFAULTS.costs.gmSalary);
            const ownerDraws = getVal('owner-draws-total', DEFAULTS.costs.ownerDrawsTotal);
            const totalMgmtCost = gmSalary + ownerDraws;
            const avgUtil = STUDIO_IDS.reduce((sum, id) => sum + getVal(`${id}-util`, DEFAULTS.studios[id].util), 0) / STUDIO_IDS.length / 100;
            
            // Get rents and ad spend
            const rents = {};
            const adSpends = {};
            STUDIO_IDS.forEach(id => {
                const def = DEFAULTS.studios[id];
                const sqft = getVal(`${id}-sqft`, def.sqft);
                const nnn = getVal(`${id}-nnn`, def.nnn);
                rents[id] = Math.round((sqft * nnn) / 12);
                adSpends[id] = getVal(`${id}-adspend`, def.adSpend);
            });
            const totalRent = Object.values(rents).reduce((a, b) => a + b, 0);
            const totalAdSpend = Object.values(adSpends).reduce((a, b) => a + b, 0);
            
            // Helper to calculate net profit for a scenario
            function calcScenarioProfit(scenarioData) {
                const totalMembers = scenarioData.total;
                const grossRev = totalMembers * arpm;
                const netRev = grossRev * (1 - totalFeePct);
                
                // Labor costs based on members (using averaged per-studio rates)
                const sessionHours = totalMembers * sessionsPm * sessionLengthHrs;
                const totalVspHours = sessionHours / avgUtil;
                const laborCost = (sessionHours * avgVspStretch) + ((totalVspHours - sessionHours) * avgVspIdle);
                const commissionCost = grossRev * vspCommission;
                
                // Fixed costs (all studios active by Dec '26)
                const fixedCosts = totalRent + (STUDIO_IDS.length * otherFixed) + totalAdSpend + totalMgmtCost;
                
                return netRev - laborCost - commissionCost - fixedCosts;
            }
            
            // Current settings
            const currentRamp = getVal('rampGrowth', DEFAULTS.growth.ramp);
            const currentChurn = getVal('churnRate', DEFAULTS.growth.churn);
            const currentMaint = getVal('maintGrowth', DEFAULTS.growth.maint);
            
            // Calculate average conversion from all studios
            const avgConvLi = STUDIO_IDS.reduce((sum, id) => sum + getVal(`${id}-conv-li`, DEFAULTS.studios[id].convLi), 0) / STUDIO_IDS.length;
            const avgConvIm = STUDIO_IDS.reduce((sum, id) => sum + getVal(`${id}-conv-im`, DEFAULTS.studios[id].convIm), 0) / STUDIO_IDS.length;
            const currentConv = (avgConvLi / 100) * (avgConvIm / 100) * 100; // Overall conversion %
            
            // Update month labels
            setHtml('scen-cons-month-label', `${endMonth} Total`);
            setHtml('scen-mod-month-label', `${endMonth} Total`);
            setHtml('scen-agg-month-label', `${endMonth} Total`);
            setHtml('scen-custom-month-label', `${endMonth} Total`);
            
            // Conservative scenario
            const cons = calculateScenario(0.08, 0.04, 0.05, seasonality);
            setHtml('scen-cons-total', cons.total);
            setHtml('scen-cons-rev', formatCurrency(cons.total * arpm));
            setHtml('scen-cons-profit', formatCurrency(calcScenarioProfit(cons)));
            setHtml('scen-cons-target', cons.targetsHit + '/' + STUDIO_IDS.length);

            // Moderate scenario
            const mod = calculateScenario(0.12, 0.05, 0.045, seasonality);
            setHtml('scen-mod-total', mod.total);
            setHtml('scen-mod-rev', formatCurrency(mod.total * arpm));
            setHtml('scen-mod-profit', formatCurrency(calcScenarioProfit(mod)));
            setHtml('scen-mod-target', mod.targetsHit + '/' + STUDIO_IDS.length);

            // Aggressive scenario  
            const agg = calculateScenario(0.15, 0.06, 0.04, seasonality);
            setHtml('scen-agg-total', agg.total);
            setHtml('scen-agg-rev', formatCurrency(agg.total * arpm));
            setHtml('scen-agg-profit', formatCurrency(calcScenarioProfit(agg)));
            setHtml('scen-agg-target', agg.targetsHit + '/' + STUDIO_IDS.length);

            // Custom (current settings)
            const customTotal = projectionData.total[getFinalMonthIndex()];
            const customTargets = STUDIO_IDS.filter(id => 
                findMonth9Value(projectionData[id]) >= getVal(`${id}-target`, DEFAULTS.studios[id].target)
            ).length;
            
            setHtml('scen-custom-ramp', currentRamp + '%');
            setHtml('scen-custom-churn', currentChurn + '%');
            setHtml('scen-custom-conv', currentConv.toFixed(0) + '%');
            setHtml('scen-custom-total', customTotal);
            setHtml('scen-custom-rev', formatCurrency(customTotal * arpm));
            setHtml('scen-custom-profit', formatCurrency(calcScenarioProfit({ total: customTotal })));
            setHtml('scen-custom-target', customTargets + '/' + STUDIO_IDS.length);
            
            // Update current settings banner
            setHtml('currentRamp', currentRamp + '%');
            setHtml('currentChurn', currentChurn + '%');
            setHtml('currentConv', currentConv.toFixed(0) + '%');
            setHtml('currentNetGrowth', (currentRamp - currentChurn).toFixed(1) + '%');
            
            // Update global settings banner (visible on all tabs)
            setHtml('globalRamp', currentRamp + '%');
            setHtml('globalMaint', currentMaint + '%');
            setHtml('globalChurn', currentChurn + '%');
            setHtml('globalConv', currentConv.toFixed(0) + '%');
            setHtml('globalNetGrowth', (currentRamp - currentChurn).toFixed(1) + '%');
            
            // Determine which preset is active (or custom)
            const presetMatch = detectActivePreset(currentRamp, currentChurn, avgConvLi);
            updateScenarioHighlight(presetMatch);

            // Scenario chart with confidence bands
            const consData = months.map((_, i) => STUDIO_IDS.reduce((sum, id) => sum + cons[id][i].members, 0));
            const modData = months.map((_, i) => STUDIO_IDS.reduce((sum, id) => sum + mod[id][i].members, 0));
            const aggData = months.map((_, i) => STUDIO_IDS.reduce((sum, id) => sum + agg[id][i].members, 0));
            
            // Confidence bands using CONFIG setting
            const upperBand = projectionData.total.map(v => Math.round(v * (1 + CONFIG.status.confidenceBandPct)));
            const lowerBand = projectionData.total.map(v => Math.round(v * (1 - CONFIG.status.confidenceBandPct)));

            if (charts.scenario) charts.scenario.destroy();
            const ctx = document.getElementById('scenarioChart')?.getContext('2d');
            if (ctx) {
                charts.scenario = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [
                            { 
                                label: '+10% Band', 
                                data: upperBand, 
                                borderColor: 'rgba(40, 167, 69, 0.3)', 
                                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                                borderWidth: 1,
                                tension: 0.4, 
                                fill: '+1',
                                pointRadius: 0
                            },
                            { 
                                label: '-10% Band', 
                                data: lowerBand, 
                                borderColor: 'rgba(40, 167, 69, 0.3)', 
                                borderWidth: 1,
                                tension: 0.4, 
                                fill: false,
                                pointRadius: 0
                            },
                            { label: 'Conservative', data: consData, borderColor: '#17a2b8', borderDash: [5, 5], tension: 0.4, fill: false, borderWidth: 2 },
                            { label: 'Moderate', data: modData, borderColor: '#28a745', borderDash: [3, 3], tension: 0.4, fill: false, borderWidth: 2 },
                            { label: 'Your Projection', data: projectionData.total, borderColor: '#6f42c1', borderWidth: 3, tension: 0.4, fill: false },
                            { label: 'Aggressive', data: aggData, borderColor: '#ffc107', borderDash: [5, 5], tension: 0.4, fill: false, borderWidth: 2 }
                        ]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        plugins: { 
                            legend: { 
                                position: 'bottom',
                                labels: {
                                    filter: (item) => !item.text.includes('Band')
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    afterBody: function(context) {
                                        const idx = context[0].dataIndex;
                                        return `¬±10% Range: ${lowerBand[idx]} - ${upperBand[idx]}`;
                                    }
                                }
                            }
                        } 
                    }
                });
            }

            // Sensitivity analysis using helper
            const ramp = currentRamp / 100;
            const maint = currentMaint / 100;
            const churn = currentChurn / 100;
            
            const churnUpScenario = calculateScenario(ramp, maint, churn + 0.01, seasonality);
            setHtml('sens-churn-up', (churnUpScenario.total - customTotal));

            const growthUpScenario = calculateScenario(ramp + 0.01, maint, churn, seasonality);
            setHtml('sens-growth-up', '+' + (growthUpScenario.total - customTotal));

            // Goal seek - binary search for required growth
            const goalTarget = getVal('goal-seek-target', 500);
            let low = 0.05, high = 0.35, mid;
            for (let iter = 0; iter < 20; iter++) {
                mid = (low + high) / 2;
                const testScenario = calculateScenario(mid, maint, churn, seasonality);
                if (testScenario.total < goalTarget) low = mid;
                else high = mid;
            }
            setHtml('goal-seek-growth', (mid * 100).toFixed(1) + '%');
            const feasBox = document.getElementById('goal-seek-feasibility');
            if (feasBox) {
                if (mid < 0.12) { feasBox.className = 'stat-box success'; feasBox.innerHTML = '<div class="value">Easy</div><div class="label">Feasibility</div>'; }
                else if (mid < 0.18) { feasBox.className = 'stat-box warning'; feasBox.innerHTML = '<div class="value">Moderate</div><div class="label">Feasibility</div>'; }
                else { feasBox.className = 'stat-box danger'; feasBox.innerHTML = '<div class="value">Difficult</div><div class="label">Feasibility</div>'; }
            }
        }
        
        // Detect which preset matches current settings
        function detectActivePreset(ramp, churn, avgConvLi) {
            // Check against PRESETS thresholds with some tolerance
            const tolerance = 0.5;
            
            if (Math.abs(ramp - 8) <= tolerance && Math.abs(churn - 5) <= tolerance) {
                return 'conservative';
            } else if (Math.abs(ramp - 12) <= tolerance && Math.abs(churn - 4.5) <= tolerance) {
                return 'moderate';
            } else if (Math.abs(ramp - 15) <= tolerance && Math.abs(churn - 4) <= tolerance) {
                return 'aggressive';
            }
            return 'custom';
        }
        
        // Update scenario card highlights
        function updateScenarioHighlight(activeScenario) {
            const scenarios = ['conservative', 'moderate', 'aggressive', 'custom'];
            
            scenarios.forEach(s => {
                const card = document.getElementById(`scenario-${s}`);
                if (card) {
                    card.classList.toggle('active', s === activeScenario);
                }
            });
            
            // Also update header preset buttons
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (activeScenario !== 'custom') {
                const btn = document.querySelector(`.preset-btn.${activeScenario}`);
                if (btn) btn.classList.add('active');
            }
            
            // Update banner text
            const names = {
                conservative: { name: 'Conservative', desc: 'Lower growth expectations, higher churn buffer', color: 'var(--info)' },
                moderate: { name: 'Moderate', desc: 'Balanced realistic growth assumptions', color: 'var(--success)' },
                aggressive: { name: 'Aggressive', desc: 'Optimistic growth, low churn targets', color: '#856404' },
                custom: { name: '‚öôÔ∏è Custom', desc: 'Your personalized scenario settings', color: '#6f42c1' }
            };
            
            setHtml('currentScenarioName', names[activeScenario].name);
            setHtml('currentScenarioDesc', names[activeScenario].desc);
            
            // Update global settings banner
            const globalName = document.getElementById('globalPresetName');
            if (globalName) {
                globalName.textContent = names[activeScenario].name;
                globalName.style.color = names[activeScenario].color;
            }
        }

        // LocalStorage save/load functions
        const STORAGE_KEY = 'vitalStretchCommandCenter';

        function saveSettings() {
            const settings = {};
            document.querySelectorAll('input, select').forEach(el => {
                if (el.id) {
                    settings[el.id] = el.value;
                }
            });
            localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
            showSaveNotification('Settings saved!');
        }

        function loadSettings() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try {
                    const settings = JSON.parse(saved);
                    Object.keys(settings).forEach(id => {
                        const el = document.getElementById(id);
                        if (el) {
                            el.value = settings[id];
                        }
                    });
                    // If time horizon was saved, regenerate month arrays
                    if (settings.timeHorizon) {
                        timeHorizonMonths = parseInt(settings.timeHorizon);
                        generateMonthArrays(timeHorizonMonths);
                    }
                    return true;
                } catch (e) {
                    console.error('Error loading settings:', e);
                    return false;
                }
            }
            return false;
        }

        function resetSettings() {
            if (confirm('Reset all settings to defaults? This cannot be undone.')) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }

        // ==========================================
        // QUICK PRESETS
        // ==========================================
        const PRESETS = {
            conservative: {
                name: 'Conservative',
                ramp: 8, maint: 4, churn: 5,
                convMultiplier: 0.85,  // 15% lower conversion
                description: 'Lower growth, higher churn'
            },
            moderate: {
                name: 'Moderate', 
                ramp: 12, maint: 5, churn: 4.5,
                convMultiplier: 1.0,   // Default conversion
                description: 'Balanced realistic growth'
            },
            aggressive: {
                name: 'Aggressive',
                ramp: 15, maint: 6, churn: 4,
                convMultiplier: 1.15,  // 15% higher conversion
                description: 'High growth, low churn'
            }
        };

        let activePreset = 'moderate';

        function applyPreset(presetName) {
            const preset = PRESETS[presetName];
            if (!preset) return;

            // Update growth settings
            document.getElementById('rampGrowth').value = preset.ramp;
            document.getElementById('maintGrowth').value = preset.maint;
            document.getElementById('churnRate').value = preset.churn;

            // Update conversion rates for each studio
            STUDIO_IDS.forEach(id => {
                const baseLi = DEFAULTS.studios[id].convLi;
                const baseIm = DEFAULTS.studios[id].convIm;
                const liEl = document.getElementById(`${id}-conv-li`);
                const imEl = document.getElementById(`${id}-conv-im`);
                if (liEl) liEl.value = Math.round(baseLi * preset.convMultiplier);
                if (imEl) imEl.value = Math.round(baseIm * preset.convMultiplier);
            });

            // Update button states
            document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.preset-btn.${presetName}`)?.classList.add('active');
            activePreset = presetName;

            showSaveNotification(`Applied ${preset.name} preset: ${preset.description}`);
            updateAll();
        }

        // ==========================================
        // PRINT MODE
        // ==========================================
        let isPrintMode = false;

        function togglePrintMode() {
            isPrintMode = !isPrintMode;
            document.body.classList.toggle('print-mode', isPrintMode);
            
            // Add tab titles for print
            const tabs = {
                'tab-dashboard': 'üìä Dashboard Overview',
                'tab-leads': 'üéØ Lead Funnel & Marketing',
                'tab-financials': 'üí∞ Financial Projections',
                'tab-operations': 'üë• Operations & Staffing',
                'tab-scenarios': 'üìà Scenario Analysis',
                'tab-franchise': '‚öôÔ∏è Franchise Setup'
            };
            
            Object.entries(tabs).forEach(([id, title]) => {
                const el = document.getElementById(id);
                if (el) el.setAttribute('data-tab-title', title);
            });

            if (isPrintMode) {
                showSaveNotification('Print mode enabled - forms hidden, all tabs visible');
            } else {
                // Restore active tab only
                document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                const activeTab = document.querySelector('.nav-tab.active');
                if (activeTab) {
                    document.getElementById('tab-' + activeTab.dataset.tab)?.classList.add('active');
                }
                showSaveNotification('Print mode disabled');
            }
        }

        function showSaveNotification(msg) {
            const notification = document.createElement('div');
            notification.textContent = msg;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                font-weight: 600;
                z-index: 1000;
                animation: fadeInOut 2s forwards;
            `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 2000);
        }

        // Add CSS animation for notification
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeInOut {
                0% { opacity: 0; transform: translateY(-10px); }
                20% { opacity: 1; transform: translateY(0); }
                80% { opacity: 1; transform: translateY(0); }
                100% { opacity: 0; transform: translateY(-10px); }
            }
        `;
        document.head.appendChild(style);

        // What-If scenario storage
        const whatIfOriginals = {};
        let activeWhatIf = null;

        function applyWhatIf(scenario) {
            // Store originals if not already stored
            if (Object.keys(whatIfOriginals).length === 0) {
                whatIfOriginals['churnRate'] = document.getElementById('churnRate')?.value;
                whatIfOriginals['rampGrowth'] = document.getElementById('rampGrowth')?.value;
                STUDIO_IDS.forEach(id => {
                    whatIfOriginals[`${id}-conv-li`] = document.getElementById(`${id}-conv-li`)?.value;
                    // Store opens value for studios that have an opens selector
                    const opensEl = document.getElementById(`${id}-opens`);
                    if (opensEl) whatIfOriginals[`${id}-opens`] = opensEl.value;
                });
                for (let i = 1; i <= 12; i++) {
                    whatIfOriginals[`season-${i}`] = document.getElementById(`season-${i}`)?.value;
                }
            }

            // Reset to originals first
            Object.keys(whatIfOriginals).forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = whatIfOriginals[id];
            });

            let impactText = '';
            
            // Apply scenario
            // Check for studio delay scenarios first (dynamic)
            const delayMatch = scenario.match(/^(.+)-delay$/);
            if (delayMatch) {
                const studioId = delayMatch[1];
                const opensEl = document.getElementById(`${studioId}-opens`);
                if (opensEl && whatIfOriginals[`${studioId}-opens`]) {
                    opensEl.value = Math.min(12, parseInt(whatIfOriginals[`${studioId}-opens`]) + CONFIG.growth.whatIfDelayMonths);
                    impactText = `${STUDIO_NAMES[studioId]} opens ${CONFIG.growth.whatIfDelayMonths} months later than planned`;
                }
            }
            
            switch(scenario) {
                case 'high-churn':
                    document.getElementById('churnRate').value = Math.min(CONFIG.growth.maxChurnRate, parseFloat(whatIfOriginals['churnRate']) + CONFIG.growth.whatIfChurnIncrease);
                    impactText = `Churn rate increases by ${CONFIG.growth.whatIfChurnIncrease} percentage points`;
                    break;
                case 'low-conv':
                    STUDIO_IDS.forEach(id => {
                        const el = document.getElementById(`${id}-conv-li`);
                        if (el) el.value = Math.round(parseFloat(whatIfOriginals[`${id}-conv-li`]) * CONFIG.conversion.lowConvScenarioFactor);
                    });
                    impactText = `Lead-to-Intro conversion drops by ${Math.round((1 - CONFIG.conversion.lowConvScenarioFactor) * 100)}%`;
                    break;
                case 'slow-ramp':
                    document.getElementById('rampGrowth').value = 10;
                    impactText = 'Ramp growth slows to 10% monthly';
                    break;
                case 'no-seasonality':
                    for (let i = 1; i <= 12; i++) {
                        document.getElementById(`season-${i}`).value = 1.0;
                    }
                    impactText = 'All seasonality effects removed (flat 1.0)';
                    break;
            }

            const impactDiv = document.getElementById('whatif-impact');
            const impactTextEl = document.getElementById('whatif-impact-text');
            if (impactDiv && impactTextEl) {
                impactDiv.style.display = 'block';
                impactTextEl.textContent = impactText;
            }

            updateAll();
        }

        function clearWhatIf() {
            Object.keys(whatIfOriginals).forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = whatIfOriginals[id];
            });
            activeWhatIf = null;
            document.getElementById('whatif-impact').style.display = 'none';
            document.querySelectorAll('.whatif-btn').forEach(btn => btn.classList.remove('active'));
            updateAll();
        }

        // Seasonality visual update
        function updateSeasonalityVisual() {
            const container = document.getElementById('seasonalityVisual');
            if (!container) return;
            
            const monthNames = ['J', 'F', 'M', 'A', 'M', 'J', 'J', 'A', 'S', 'O', 'N', 'D'];
            let html = '';
            
            for (let i = 1; i <= 12; i++) {
                const val = parseFloat(document.getElementById(`season-${i}`)?.value || 1);
                let cls = 'season-normal';
                if (val >= 1.1) cls = 'season-high';
                else if (val <= 0.9) cls = 'season-low';
                
                html += `<div class="season-bar ${cls}" title="${getMonthName(i)}: ${(val * 100).toFixed(0)}%">${monthNames[i-1]}<br>${(val * 100).toFixed(0)}%</div>`;
            }
            container.innerHTML = html;
        }
        
        function getMonthName(num) {
            const names = ['', 'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            return names[num] || '';
        }

        // Input validation
        function validateInputs() {
            let valid = true;
            
            // Validate member counts (non-negative)
            STUDIO_IDS.forEach(id => {
                const el = document.getElementById(`${id}-current`);
                if (el && parseFloat(el.value) < 0) {
                    el.classList.add('invalid');
                    valid = false;
                } else if (el) {
                    el.classList.remove('invalid');
                }
            });
            
            // Validate percentages (0-100 for conversion rates)
            STUDIO_IDS.forEach(id => {
                ['conv-li', 'conv-im'].forEach(suffix => {
                    const el = document.getElementById(`${id}-${suffix}`);
                    if (el) {
                        const val = parseFloat(el.value);
                        if (val < 0 || val > 100) {
                            el.classList.add('invalid');
                            valid = false;
                        } else {
                            el.classList.remove('invalid');
                        }
                    }
                });
            });
            
            // Validate seasonality (0.5-2.0)
            for (let i = 1; i <= 12; i++) {
                const el = document.getElementById(`season-${i}`);
                if (el) {
                    const val = parseFloat(el.value);
                    if (val < 0.5 || val > 2) {
                        el.classList.add('invalid');
                        valid = false;
                    } else {
                        el.classList.remove('invalid');
                    }
                }
            }
            
            return valid;
        }

        // Update staff cost per member in Operations
        function updateStaffCostPerMember(laborCosts, totalMembers) {
            // Calculate average labor cost per member across all months
            const avgLaborCost = laborCosts.reduce((a, b) => a + b, 0) / laborCosts.length;
            const avgMembers = totalMembers.reduce((a, b) => a + b, 0) / totalMembers.length;
            const costPerMember = avgMembers > 0 ? avgLaborCost / avgMembers : 0;
            
            setHtml('staff-cost-per-member', '$' + Math.round(costPerMember));
            
            // Color code based on efficiency
            const box = document.getElementById('staff-cost-box');
            if (box) {
                if (costPerMember <= 35) box.className = 'stat-box success';
                else if (costPerMember <= 50) box.className = 'stat-box warning';
                else box.className = 'stat-box danger';
            }
            
            // Labor efficiency trend (quarterly snapshots)
            const trendEl = document.getElementById('labor-efficiency-trend');
            if (trendEl && totalMembers.length >= 12) {
                const quarters = [
                    { label: 'Q1', cost: (laborCosts[0] + laborCosts[1] + laborCosts[2]) / (totalMembers[0] + totalMembers[1] + totalMembers[2] || 1) * 3 },
                    { label: 'Q2', cost: (laborCosts[3] + laborCosts[4] + laborCosts[5]) / (totalMembers[3] + totalMembers[4] + totalMembers[5] || 1) * 3 },
                    { label: 'Q3', cost: (laborCosts[6] + laborCosts[7] + laborCosts[8]) / (totalMembers[6] + totalMembers[7] + totalMembers[8] || 1) * 3 },
                    { label: 'Q4', cost: (laborCosts[9] + laborCosts[10] + laborCosts[11]) / (totalMembers[9] + totalMembers[10] + totalMembers[11] || 1) * 3 }
                ];
                
                trendEl.innerHTML = quarters.map(q => {
                    const color = q.cost <= 35 ? 'var(--success)' : q.cost <= 50 ? '#856404' : 'var(--danger)';
                    return `<span style="background: var(--gray); padding: 0.25rem 0.5rem; border-radius: 4px;"><strong>${q.label}:</strong> <span style="color: ${color};">$${Math.round(q.cost)}</span></span>`;
                }).join('');
            }
        }

        // Event listeners
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                this.classList.add('active');
                document.getElementById('tab-' + this.dataset.tab).classList.add('active');
            });
        });

        document.querySelectorAll('input, select').forEach(el => {
            el.addEventListener('input', updateAll);
            el.addEventListener('change', updateAll);
        });

        // What-If button listeners (using event delegation to handle dynamic buttons)
        document.getElementById('whatIfButtonsContainer')?.addEventListener('click', function(e) {
            const btn = e.target.closest('.whatif-btn');
            if (!btn) return;
            
            const scenario = btn.dataset.whatif;
            
            // Toggle off if already active
            if (activeWhatIf === scenario) {
                clearWhatIf();
                return;
            }
            
            // Deactivate other buttons
            document.querySelectorAll('.whatif-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            activeWhatIf = scenario;
            
            applyWhatIf(scenario);
        });

        // Auto-save on change (debounced)
        let saveTimeout;
        document.querySelectorAll('input, select').forEach(el => {
            el.addEventListener('change', () => {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(saveSettings, 1000);
            });
        });

        // Generate dynamic HTML elements
        generateStudioCards();
        generateConversionDisplays();
        generateOpsUtilDisplays();
        generateWhatIfDelayButtons();
        
        // Generate dynamic what-if delay buttons for new studios
        function generateWhatIfDelayButtons() {
            const container = document.getElementById('whatIfButtonsContainer');
            if (!container) return;
            
            // Find studios with 'opens' property and add delay buttons at the beginning
            const newStudios = STUDIO_IDS.filter(id => DEFAULTS.studios[id].opens !== undefined);
            const buttons = newStudios.map(id => 
                `<button class="whatif-btn" data-whatif="${id}-delay" title="${STUDIO_NAMES[id]} opens 2 months later">üè¢ ${STUDIO_NAMES[id]} Delays 2mo</button>`
            ).join('');
            
            container.insertAdjacentHTML('afterbegin', buttons);
        }
        
        // Add event listeners to dynamically generated inputs
        document.querySelectorAll('#studioCardsContainer input, #studioCardsContainer select').forEach(el => {
            el.addEventListener('input', updateAll);
            el.addEventListener('change', updateAll);
            el.addEventListener('change', () => {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(saveSettings, 1000);
            });
        });

        // Generate seasonality dropdowns dynamically
        (function initSeasonalityDropdowns() {
            const container = document.getElementById('seasonalityInputs');
            if (!container) return;
            
            MONTH_NAMES.forEach((month, i) => {
                const div = document.createElement('div');
                div.className = 'form-group';
                const defaultVal = DEFAULTS.seasonality[i + 1];
                
                let options = '';
                // Use integer math to avoid floating point precision issues
                const minVal = Math.round(CONFIG.display.seasonalityMin * 100);
                const maxVal = Math.round(CONFIG.display.seasonalityMax * 100);
                const stepVal = Math.round(CONFIG.display.seasonalityStep * 100);
                for (let v = minVal; v <= maxVal; v += stepVal) {
                    const val = (v / 100).toFixed(2);
                    const selected = Math.abs((v / 100) - defaultVal) < 0.01 ? ' selected' : '';
                    options += `<option value="${val}"${selected}>${val}</option>`;
                }
                
                div.innerHTML = `<label>${month}</label><select id="season-${i + 1}">${options}</select>`;
                container.appendChild(div);
            });
            
            // Add event listeners to the new selects
            container.querySelectorAll('select').forEach(el => {
                el.addEventListener('input', updateAll);
                el.addEventListener('change', updateAll);
                el.addEventListener('change', () => {
                    clearTimeout(saveTimeout);
                    saveTimeout = setTimeout(saveSettings, 1000);
                });
            });
        })();

        // Load saved settings on startup
        const hadSavedSettings = loadSettings();

        // Initialize table headers and update
        regenerateTableHeaders();
        updateAll();

        // Show loaded notification if settings were restored
        if (hadSavedSettings) {
            setTimeout(() => showSaveNotification('Settings restored!'), 500);
        }
    </script>
</body>
</html>
